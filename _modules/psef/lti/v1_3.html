

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.lti.v1_3 &mdash; CodeGrade LowVoltage.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                LowVoltage.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-as-a-student.html">How to use CodeGrade as a student</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/autotest-best-practices.html">Best Practices for AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-autotest.html">Setting up AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/enabling-continuous-feedback-for-an-assignment.html">Enabling Continuous Feedback for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setting-up-git-uploads.html">Set up Git uploads for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/installing-codegrade-filesystem.html">Install the CodeGrade Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/use-codegrade-filesystem.html">Use the CodeGrade Filesystem to locally mount CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/lms.html">LMS Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/autotest/overview.html">AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/analytics-dashboard.html">Analytics Dashboard</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../psef.html">psef</a> &raquo;</li>
        
          <li><a href="../lti.html">psef.lti</a> &raquo;</li>
        
      <li>psef.lti.v1_3</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.lti.v1_3</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This file implements the main logic for handling LTI 1.3 launches.</span>

<span class="sd">LTI 1.3 depends on an OpenId Connect like authentication flow, I really</span>
<span class="sd">recommend that you read the actual docs for LTI 1.3 (see the IMS Global</span>
<span class="sd">website), but here is short recap.</span>

<span class="sd">First a user navigates to a page of the LMS (Platform in LTI 1.3 terms, tool</span>
<span class="sd">consumer in LTI 1.1 terms) which redirects the user to the OIDC login endpoint</span>
<span class="sd">of CodeGrade (Tool in LTI 1.3 terms, Tool Provider in LTI 1.1 terms). We verify</span>
<span class="sd">some things in this OIDC login request, and save state in the session of the</span>
<span class="sd">user (to prevent replay attacks), and redirect the user to a page specified in</span>
<span class="sd">the ODIC login request. The LMS now redirects the user again, but now to the</span>
<span class="sd">launch url.</span>

<span class="sd">We verify the request (by using the public key from the tool, which we will</span>
<span class="sd">probably download or get from our cache, see</span>
<span class="sd">:meth:`.FlaskMessageLaunch.fetch_public_key`), and verify that the state saved</span>
<span class="sd">in the OIDC login request is present and correct. This finalizes the LTI stage</span>
<span class="sd">of the protocol.</span>

<span class="sd">Now we will do an extra redirection step. This is partly done to be able to</span>
<span class="sd">reuse logic of our LTI 1.1 implementation (which does this for legacy reasons),</span>
<span class="sd">but also to get some state inside our Vue application.</span>

<span class="sd">We save the data in the launch request to our :class:`psef.models.BlobStorage`</span>
<span class="sd">table, and redirect the user to the CodeGrade LTI launch page. Javascript on</span>
<span class="sd">this page will post to the ``/api/v1/lti/launch/2`` endpoint with the id for</span>
<span class="sd">the blob storage object. We will now create a :class:`.FlaskMessageLaunch`</span>
<span class="sd">using this data, and execute the</span>
<span class="sd">:meth:`psef.lti.abstract.do_second_step_of_lti` method.</span>

<span class="sd">.. seealso::</span>

<span class="sd">    The main `LTI 1.3 documentation &lt;http://www.imsglobal.org/spec/lti/v1p3&gt;`_.</span>

<span class="sd">    `OIDC login flow &lt;https://www.imsglobal.org/spec/security/v1p0/#fig_oidcflow&gt;`_</span>
<span class="sd">    from the LMS documentation. This shows the redirection flow.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>

<span class="kn">import</span> <span class="nn">werkzeug</span>
<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">from</span> <span class="nn">pylti1p3</span> <span class="kn">import</span> <span class="n">grade</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Final</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">TypedDict</span>
<span class="kn">from</span> <span class="nn">pylti1p3.oidc_login</span> <span class="kn">import</span> <span class="n">OIDCLogin</span>
<span class="kn">from</span> <span class="nn">pylti1p3.tool_config</span> <span class="kn">import</span> <span class="n">ToolConfAbstract</span>
<span class="kn">from</span> <span class="nn">pylti1p3.registration</span> <span class="kn">import</span> <span class="n">Registration</span>
<span class="kn">from</span> <span class="nn">pylti1p3.message_launch</span> <span class="kn">import</span> <span class="n">MessageLaunch</span>
<span class="kn">from</span> <span class="nn">pylti1p3.service_connector</span> <span class="kn">import</span> <span class="n">ServiceConnector</span>
<span class="kn">from</span> <span class="nn">pylti1p3.assignments_grades</span> <span class="kn">import</span> <span class="n">AssignmentsGradesService</span>
<span class="kn">from</span> <span class="nn">pylti1p3.deep_link_resource</span> <span class="kn">import</span> <span class="n">DeepLinkResource</span>

<span class="kn">import</span> <span class="nn">cg_override</span>
<span class="kn">from</span> <span class="nn">cg_dt_utils</span> <span class="kn">import</span> <span class="n">DatetimeWithTimezone</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">claims</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">PsefFlask</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">helpers</span><span class="p">,</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">.flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FlaskRequest</span><span class="p">,</span> <span class="n">FlaskRedirect</span><span class="p">,</span> <span class="n">FlaskCookieService</span><span class="p">,</span> <span class="n">FlaskSessionService</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.roles</span> <span class="kn">import</span> <span class="n">SystemRole</span>
<span class="kn">from</span> <span class="nn">...models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">..abstract</span> <span class="kn">import</span> <span class="n">AbstractLTIConnector</span>
<span class="kn">from</span> <span class="nn">...exceptions</span> <span class="kn">import</span> <span class="n">APICodes</span><span class="p">,</span> <span class="n">APIException</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="c1"># pylint: disable=unused-import</span>
    <span class="kn">from</span> <span class="nn">.lms_capabilities</span> <span class="kn">import</span> <span class="n">LMSCapabilities</span>
    <span class="kn">from</span> <span class="nn">pylti1p3.message_launch</span> <span class="kn">import</span> <span class="n">_JwtData</span><span class="p">,</span> <span class="n">_LaunchData</span><span class="p">,</span> <span class="n">_KeySet</span><span class="p">,</span> <span class="n">_DeepLinkData</span>

<span class="n">NEEDED_AGS_SCOPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;https://purl.imsglobal.org/spec/lti-ags/scope/score&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">NEEDED_SCOPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">*</span><span class="n">NEEDED_AGS_SCOPES</span><span class="p">,</span>
    <span class="s1">&#39;https://purl.imsglobal.org/spec/lti-nrps/scope/contextmembership.readonly&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">MemberLike</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;MemberLike&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_TestCookie</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class contains the functionality for a test cookie.</span>

<span class="sd">    This cookie tests if we are able to set at all in an LTI launch.</span>

<span class="sd">    Currently :mod:`pylti1p3` also implements some form of testing if cookies</span>
<span class="sd">    are enabled, however that is done quite a bit differently. It redirects</span>
<span class="sd">    users to a specific page after the OIDC login (effectively stopping the</span>
<span class="sd">    launch there for a while) which checks the cookies and if it is able to set</span>
<span class="sd">    cookies it resumes the LTI flow (by redirecting to the correct OIDC</span>
<span class="sd">    redirection point). The advantage of this flow is that it is easier to</span>
<span class="sd">    detect if cookies are not working, but it also has disadvantages. The first</span>
<span class="sd">    one is that does an extra redirect for every user, even those without any</span>
<span class="sd">    cookie issues, furthermore it doesn&#39;t finish the LTI launch, so we are not</span>
<span class="sd">    able to use the (Canvas specific) features of the LMS to try and set</span>
<span class="sd">    cookies. In other words: we now that this functionality can be achieved</span>
<span class="sd">    using the library we are using, but we think our solution better suits our</span>
<span class="sd">    needs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_NAME</span> <span class="o">=</span> <span class="s1">&#39;CG_TEST_COOKIE&#39;</span>
    <span class="n">_MAX_DIFF</span> <span class="o">=</span> <span class="mi">600</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">FlaskCookieService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method sets the test cookie in the given cookie ``service``.</span>

<span class="sd">        :param service: The service in which you want to set the cookie.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">service</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_NAME</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear_cookie_in_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">FlaskCookieService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear the test cookie in the given ``service``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">service</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_NAME</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_value_in_request</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">FlaskCookieService</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the test cookie, for both existence and correctness.</span>

<span class="sd">        :param service: The cookie service in which we should look for the</span>
<span class="sd">            cookie.</span>
<span class="sd">        :param provider: The LTI provider of this launch. This parameter is</span>
<span class="sd">            used to see if we can try to do anything about the issue. See the</span>
<span class="sd">            :meth:`psef.lti.v1_3.LMSCapabilities.cookie_post_message`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_NAME</span><span class="p">)</span>
        <span class="c1"># Make sure the next launch tests for existence of the cookie again.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">clear_cookie_in_request</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test cookie was not set&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MissingCookieError</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>

        <span class="c1"># We store the time in the cookie to make sure we are actually seeing a</span>
        <span class="c1"># recent test cookie. This is to make sure we were able to set cookies</span>
        <span class="c1"># in the last OIDC login request. The method is not really precise (it</span>
        <span class="c1"># simply checks that the cookie is not too old, not that it was really</span>
        <span class="c1"># set in the last OIDC login), but this class isn&#39;t used for security</span>
        <span class="c1"># purposes so it doesn&#39;t really matter.</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">found</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test cookie had invalid data&#39;</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_MAX_DIFF</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_MAX_DIFF</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Test cookie was to old&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MissingCookieError</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>


<div class="viewcode-block" id="MissingCookieError"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.MissingCookieError">[docs]</a><span class="k">class</span> <span class="nc">MissingCookieError</span><span class="p">(</span><span class="n">APIException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the error that gets raised when we detected that we are not</span>
<span class="sd">    allowed to set cookies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;Couldn&#39;t set needed cookies&quot;</span><span class="p">,</span>
            <span class="s1">&#39;We were not allowed to set the necessary cookies&#39;</span><span class="p">,</span>
            <span class="n">APICodes</span><span class="o">.</span><span class="n">LTI1_3_COOKIE_ERROR</span><span class="p">,</span>
            <span class="mi">400</span><span class="p">,</span>
            <span class="n">lms_capabilities</span><span class="o">=</span><span class="n">provider</span><span class="o">.</span><span class="n">lms_capabilities</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="get_email_for_user"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.get_email_for_user">[docs]</a><span class="k">def</span> <span class="nf">get_email_for_user</span><span class="p">(</span>
    <span class="n">member</span><span class="p">:</span> <span class="n">MemberLike</span><span class="p">,</span>
    <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">test_student_email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;test_student@codegra.de&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get the email for something that looks like an LTI member.</span>

<span class="sd">    This method takes possible test students into account, for which it returns</span>
<span class="sd">    the given ``test_student_email`` if no email was found for the student.</span>

<span class="sd">    :param member: The received member from the LTI message.</span>
<span class="sd">    :param provider: The LTI provider that received the message. This is used</span>
<span class="sd">        to determine what the name of the test student would be, if anything.</span>
<span class="sd">    :param test_student_email: The email to return if no email was found for</span>
<span class="sd">        the given member, and we determined that the given member was indeed a</span>
<span class="sd">        test student.</span>

<span class="sd">    :raises KeyError: If the given user is not a test student and doesn&#39;t have</span>
<span class="sd">        an email (i.e. this function will always return an email in that case).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">caps</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">lms_capabilities</span>
    <span class="n">test_stud_name</span> <span class="o">=</span> <span class="n">caps</span><span class="o">.</span><span class="n">test_student_name</span>
    <span class="k">if</span> <span class="n">test_stud_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">test_stud_name</span> <span class="o">==</span> <span class="n">full_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">test_student_email</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">member</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="CGRegistration"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGRegistration">[docs]</a><span class="k">class</span> <span class="nc">CGRegistration</span><span class="p">(</span><span class="n">Registration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class represents a registration, something used internally by the</span>
<span class="sd">    :mod:`pylti1p3` library.</span>

<span class="sd">    This class only adds a nice constructor, so you can easily create a</span>
<span class="sd">    registration using a :class:`.models.LTI1p3Provider`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">_auth_login_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">auth_token_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">key_set_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">iss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">provider</span><span class="o">.</span><span class="n">auth_audience</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_auth_login_url</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">_auth_login_url</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_auth_token_url</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">auth_token_url</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_client_id</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_key_set_url</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">key_set_url</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_issuer</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">iss</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_tool_public_key</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">get_public_key</span><span class="p">())</span> \
            <span class="o">.</span><span class="n">set_auth_audience</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">auth_audience</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_tool_private_key</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">_private_key</span><span class="p">)</span></div>


<div class="viewcode-block" id="CGServiceConnector"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGServiceConnector">[docs]</a><span class="k">class</span> <span class="nc">CGServiceConnector</span><span class="p">(</span><span class="n">ServiceConnector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class implements the authenticated back channel as defined by the</span>
<span class="sd">    LTI 1.3 spec.</span>

<span class="sd">    This is heavily used by the :mod:`pylti1p3`, and completely implemented by</span>
<span class="sd">    them. The only thing we add in our subclass is caching of the access tokens</span>
<span class="sd">    needed to make authenticated requests. Caching is done using our</span>
<span class="sd">    :mod:`cg_cache.inter_reqeust` caching functionality.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">get_registration</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span> <span class="o">=</span> <span class="n">provider</span>

<div class="viewcode-block" id="CGServiceConnector.get_access_token"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGServiceConnector.get_access_token">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">get_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scopes</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the access token for the given scopes.</span>

<span class="sd">        This method is simply a caching wrapper over the implementation of the</span>
<span class="sd">        base implementation.</span>

<span class="sd">        :param scopes: The scopes for which you want to get an access token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scopes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>
        <span class="n">scopes_str</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">inter_request_cache</span><span class="o">.</span><span class="n">lti_access_tokens</span>
        <span class="n">super_method</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_access_token</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="o">.</span><span class="n">auth_token_url</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">scopes_str</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_or_set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">super_method</span><span class="p">(</span><span class="n">scopes</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CGGrade"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGGrade">[docs]</a><span class="k">class</span> <span class="nc">CGGrade</span><span class="p">(</span><span class="n">grade</span><span class="o">.</span><span class="n">Grade</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class implementing a grade, as needed by the :mod:`pylti1p3` library</span>
<span class="sd">        for the grades service.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;models.Assignment&#39;</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span><span class="p">,</span>
        <span class="n">provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_score_maximum</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">GRADE_SCALE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_timestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span></div>


<div class="viewcode-block" id="CGAssignmentsGradesService"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGAssignmentsGradesService">[docs]</a><span class="k">class</span> <span class="nc">CGAssignmentsGradesService</span><span class="p">(</span><span class="n">AssignmentsGradesService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class implementing the grades service for LTI 1.3.</span>

<span class="sd">    Implementation is done using the :mod:`pylti1p3` library, this class simply</span>
<span class="sd">    adds a nicer constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">service_connector</span><span class="p">:</span> <span class="n">ServiceConnector</span><span class="p">,</span>
        <span class="n">assignment</span><span class="p">:</span> <span class="s1">&#39;models.Assignment&#39;</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">assignment</span><span class="o">.</span><span class="n">is_lti</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assignment</span><span class="o">.</span><span class="n">lti_grade_service_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="n">service_data</span> <span class="o">=</span> <span class="n">assignment</span><span class="o">.</span><span class="n">lti_grade_service_data</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">service_connector</span><span class="p">,</span> <span class="n">service_data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created assignments service&#39;</span><span class="p">,</span> <span class="n">service_data</span><span class="o">=</span><span class="n">service_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assignment</span> <span class="o">=</span> <span class="n">assignment</span></div>


<div class="viewcode-block" id="CGCustomClaims"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims">[docs]</a><span class="k">class</span> <span class="nc">CGCustomClaims</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class represents the definition and parsing of custom claims.</span>

<span class="sd">    This actually also uses non custom claim data, in the case the custom claim</span>
<span class="sd">    wasn&#39;t present.</span>

<span class="sd">    The wanted variables are defined in the ``_WANTED_VARS`` array in this</span>
<span class="sd">    class. Each variable (wanted piece of information) has multiple options,</span>
<span class="sd">    these are the places we might find this piece of information. Each options</span>
<span class="sd">    can be a :class:`.CGCustomClaims.ReplacementVar`: something we might find</span>
<span class="sd">    in the custom claims, or a :class:`.CGCustomClaims.AbsoluteVar` something</span>
<span class="sd">    that we might find outside of the custom claims.</span>

<span class="sd">    The order of the options matters for two reasons: 1) it matters for how the</span>
<span class="sd">    user is instructed to add the variables to their LMS when configuring</span>
<span class="sd">    CodeGrade, and 2) it defines the order in which the variables are parsed.</span>
<span class="sd">    The options are iterated one by one if and we find the information using an</span>
<span class="sd">    option we stop parsing, i.e. earlier options take precedence.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CGCustomClaims.ClaimResult"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.ClaimResult">[docs]</a>    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">ClaimResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The result of parsing the custom claims.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">username</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">deadline</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span>
        <span class="n">is_available</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
        <span class="n">resource_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>

<div class="viewcode-block" id="CGCustomClaims.ReplacementVar"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.ReplacementVar">[docs]</a>    <span class="k">class</span> <span class="nc">ReplacementVar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This represents a replacement variable, i.e. a variable that we</span>
<span class="sd">        might find in the custom claims section of the LTI message.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exploded_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CGCustomClaims.ReplacementVar.matches_group"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.ReplacementVar.matches_group">[docs]</a>        <span class="k">def</span> <span class="nf">matches_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Check if given group matches</span>

<span class="sd">            &gt;&gt;&gt; var = CGCustomClaims.ReplacementVar(&#39;$a.b.cc.d&#39;)</span>
<span class="sd">            &gt;&gt;&gt; var.matches_group([&#39;$a&#39;])</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; var.matches_group(&#39;$a.b.cc&#39;.split(&#39;.&#39;))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; var.matches_group(&#39;$a.c.d&#39;.split(&#39;.&#39;))</span>
<span class="sd">            False</span>
<span class="sd">            &gt;&gt;&gt; var.matches_group(&#39;$a.b.c&#39;.split(&#39;.&#39;))</span>
<span class="sd">            False</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">found</span> <span class="o">==</span> <span class="n">wanted</span>
                <span class="k">for</span> <span class="n">found</span><span class="p">,</span> <span class="n">wanted</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exploded_name</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CGCustomClaims.ReplacementVar.find_in_data"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.ReplacementVar.find_in_data">[docs]</a>        <span class="k">def</span> <span class="nf">find_in_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                         <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Find this variable in the given data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">found_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">found_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_val</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">found_val</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>

<div class="viewcode-block" id="CGCustomClaims.AbsoluteVar"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.AbsoluteVar">[docs]</a>    <span class="k">class</span> <span class="nc">AbsoluteVar</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This represents a absolute variable, i.e. any variable that is not</span>
<span class="sd">        present in the custom claims section of the LTI message.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">maybe_wrap_in_list</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="CGCustomClaims.AbsoluteVar.find_in_data"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.AbsoluteVar.find_in_data">[docs]</a>        <span class="k">def</span> <span class="nf">find_in_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Find this variable in the given data.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">found_val</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">deep_get</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">found_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">found_val</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>

    <span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">_Var</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">opts</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;CGCustomClaims.ReplacementVar&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;CGCustomClaims.AbsoluteVar&#39;</span><span class="p">]]</span>

        <span class="k">def</span> <span class="nf">get_replacement_opts</span><span class="p">(</span>
            <span class="bp">self</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="s1">&#39;CGCustomClaims.ReplacementVar&#39;</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Get all options in this variable that are instances of</span>
<span class="sd">            :class:`.CGCustomClaims.ReplacementVar`.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">ReplacementVar</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">opt</span>

        <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">_WANTED_VARS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_Var</span><span class="p">(</span>
            <span class="s1">&#39;cg_username&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$User.username&#39;</span><span class="p">),</span>
                <span class="n">AbsoluteVar</span><span class="p">([</span><span class="s1">&#39;http://www.brightspace.com&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">]),</span>
                <span class="c1"># Not used at this moment by Brightspace but they might switch.</span>
                <span class="n">AbsoluteVar</span><span class="p">([</span><span class="s1">&#39;https://www.brightspace.com&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">]),</span>
                <span class="n">AbsoluteVar</span><span class="p">(</span><span class="s1">&#39;lis_person_sourcedid&#39;</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="n">_Var</span><span class="p">(</span>
            <span class="s1">&#39;cg_deadline&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$ResourceLink.submission.endDateTime&#39;</span><span class="p">),</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$Canvas.assignment.dueAt.iso8601&#39;</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="n">_Var</span><span class="p">(</span>
            <span class="s1">&#39;cg_available_at&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$ResourceLink.submission.startDateTime&#39;</span><span class="p">)],</span>
        <span class="p">),</span>
        <span class="n">_Var</span><span class="p">(</span>
            <span class="s1">&#39;cg_is_published&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$Canvas.assignment.published&#39;</span><span class="p">)],</span>
        <span class="p">),</span>
        <span class="n">_Var</span><span class="p">(</span>
            <span class="s1">&#39;cg_resource_id&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$ResourceLink.id&#39;</span><span class="p">),</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$com.instructure.Assignment.lti.id&#39;</span><span class="p">),</span>
                <span class="n">AbsoluteVar</span><span class="p">([</span><span class="n">claims</span><span class="o">.</span><span class="n">RESOURCE</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]),</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="c1"># We don&#39;t support a lock date just yet, but if we do in the future we</span>
        <span class="c1"># already get this info from the LTI 1.3 tools.</span>
        <span class="n">_Var</span><span class="p">(</span>
            <span class="s1">&#39;cg_lock_date&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$ResourceLink.available.endDateTime&#39;</span><span class="p">),</span>
                <span class="n">ReplacementVar</span><span class="p">(</span><span class="s1">&#39;$Canvas.assignment.lockAt.iso8601&#39;</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">_VAR_LOOKUP</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">_WANTED_VARS</span><span class="p">}</span>

    <span class="n">_DEFAULT_REPLACEMENT_GROUPS</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;$User&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;$ResourceLink&#39;</span><span class="p">]]</span>

<div class="viewcode-block" id="CGCustomClaims.get_variable_claims_config"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.get_variable_claims_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_variable_claims_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lms_capabilities</span><span class="p">:</span> <span class="s1">&#39;LMSCapabilities&#39;</span>
                                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the custom claims config for the given capabilities.</span>

<span class="sd">        :param lms_capabilities: This is used to determine which replacement</span>
<span class="sd">            groups are supported, see</span>
<span class="sd">            :meth:`psef.lti.v1_3.LMSCapabilities.supported_custom_replacement_groups`</span>
<span class="sd">            for how this is used.</span>

<span class="sd">        :returns: A mapping representing the wanted custom config. The key in</span>
<span class="sd">                  the mapping is how the variable should be named in the custom</span>
<span class="sd">                  claim, and the value is the replacement var that should be</span>
<span class="sd">                  used. The values are already prefixed with the necessary &#39;$&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">custom_groups</span> <span class="o">=</span> <span class="n">lms_capabilities</span><span class="o">.</span><span class="n">supported_custom_replacement_groups</span>
        <span class="n">allowed_groups</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_DEFAULT_REPLACEMENT_GROUPS</span><span class="p">,</span> <span class="o">*</span><span class="n">custom_groups</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_WANTED_VARS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">get_replacement_opts</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">matches_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">allowed_groups</span><span class="p">):</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_claim</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">custom_data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">base_data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">converter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_VAR_LOOKUP</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">opts</span><span class="p">):</span>
            <span class="n">found_val</span><span class="p">:</span> <span class="nb">object</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ReplacementVar</span><span class="p">):</span>
                <span class="n">found_val</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">find_in_data</span><span class="p">(</span><span class="n">custom_data</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">found_val</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">find_in_data</span><span class="p">(</span><span class="n">base_data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">found_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">converter</span><span class="p">(</span><span class="n">found_val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">res</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_str_not_empty</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">inp</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_isoformat</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">inp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">parse_isoformat</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="CGCustomClaims.get_custom_claim_data"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGCustomClaims.get_custom_claim_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_custom_claim_data</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">custom_claims</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">base_data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CGCustomClaims.ClaimResult&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse the custom claims for the given custom claim and base data.</span>

<span class="sd">        :param custom_claims: The custom claims to be parsed.</span>
<span class="sd">        :param base_data: The base data, this should be the location where we</span>
<span class="sd">            can find the :class:`.CGCustomClaims.AbsoluteVar` data.</span>

<span class="sd">        :returns: The parsed data, please note that ``None`` will be used for</span>
<span class="sd">                  data that either was not present, or could not be parsed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_claim</span><span class="p">(</span>
            <span class="s1">&#39;cg_username&#39;</span><span class="p">,</span> <span class="n">custom_claims</span><span class="p">,</span> <span class="n">base_data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_str_not_empty</span>
        <span class="p">)</span>

        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_claim</span><span class="p">(</span>
            <span class="s1">&#39;cg_resource_id&#39;</span><span class="p">,</span> <span class="n">custom_claims</span><span class="p">,</span> <span class="n">base_data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_str_not_empty</span>
        <span class="p">)</span>

        <span class="n">deadline</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_claim</span><span class="p">(</span>
            <span class="s1">&#39;cg_deadline&#39;</span><span class="p">,</span> <span class="n">custom_claims</span><span class="p">,</span> <span class="n">base_data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_isoformat</span>
        <span class="p">)</span>

        <span class="n">available_at</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_claim</span><span class="p">(</span>
            <span class="s1">&#39;cg_available_at&#39;</span><span class="p">,</span> <span class="n">custom_claims</span><span class="p">,</span> <span class="n">base_data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse_isoformat</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">available_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_available</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_claim</span><span class="p">(</span>
                <span class="s1">&#39;cg_is_published&#39;</span><span class="p">,</span>
                <span class="n">custom_claims</span><span class="p">,</span>
                <span class="n">base_data</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_available</span> <span class="o">=</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">available_at</span>

        <span class="k">return</span> <span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">ClaimResult</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">,</span>
            <span class="n">is_available</span><span class="o">=</span><span class="n">is_available</span><span class="p">,</span>
            <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="CGDeepLinkResource"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGDeepLinkResource">[docs]</a><span class="k">class</span> <span class="nc">CGDeepLinkResource</span><span class="p">(</span><span class="n">DeepLinkResource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class representing a deep link.</span>

<span class="sd">    Deep links are not used by CodeGrade for their intended purpose (finding</span>
<span class="sd">    content in a tool and using that in the LMS), however we still use them.</span>
<span class="sd">    The UI for creating tools that support deep linking is much better in some</span>
<span class="sd">    cases (Brightspace), and sometimes even required (Canvas). So CodeGrade</span>
<span class="sd">    uses deeplinking in the following way: if we get a deeplinking request we</span>
<span class="sd">    do not prompt anything from the user, but simply directly return a resource</span>
<span class="sd">    the LMS. This resource is practically empty, and does not exist in our</span>
<span class="sd">    database, but this allows us to benefit from the UI of deep linking.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_deadline</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">message_launch</span><span class="p">:</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CGDeepLinkResource&#39;</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@t</span><span class="o">.</span><span class="n">overload</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">,</span>
        <span class="n">deadline</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CGDeepLinkResource&#39;</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="CGDeepLinkResource.make"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGDeepLinkResource.make">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">no_override</span>
    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">message_launch</span><span class="p">:</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deadline</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CGDeepLinkResource&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make a practically empty deep link resource.</span>

<span class="sd">        :param message_launch: The launch deep link launch in which we should</span>
<span class="sd">            create the result. We use this launch to set the correct launch url</span>
<span class="sd">            on the resource.</span>

<span class="sd">        :returns: The created resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lti_provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">message_launch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">message_launch</span><span class="o">.</span><span class="n">is_deep_link_launch</span><span class="p">()</span>
            <span class="n">lti_provider</span> <span class="o">=</span> <span class="n">message_launch</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deadline</span> <span class="o">=</span> <span class="n">deadline</span>  <span class="c1"># pylint: disable=protected-access</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">lti_provider</span><span class="o">.</span><span class="n">get_launch_url</span><span class="p">(</span><span class="n">goto_latest_sub</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_url</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">set_custom_params</span><span class="p">(</span>
            <span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">get_variable_claims_config</span><span class="p">(</span>
                <span class="n">lti_provider</span><span class="o">.</span><span class="n">lms_capabilities</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CGDeepLinkResource.to_dict"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.CGDeepLinkResource.to_dict">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deadline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;submission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;endDateTime&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deadline</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="LTIConfig"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig">[docs]</a><span class="k">class</span> <span class="nc">LTIConfig</span><span class="p">(</span><span class="n">ToolConfAbstract</span><span class="p">[</span><span class="n">FlaskRequest</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;This class implements the connection between our database an the needed</span>
<span class="sd">    (by :mod:`pyltip13`) config store.</span>

<span class="sd">    It works by finding (or verifying if you passed on in the constructor) a</span>
<span class="sd">    :class:`.models.LTI1p3Provider` using the given data. This provider</span>
<span class="sd">    contains the necessary data to construct the wanted, by :mod:`pylti1p3`,</span>
<span class="sd">    classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lti_provider</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_extended_search</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span> <span class="o">=</span> <span class="n">lti_provider</span>

<div class="viewcode-block" id="LTIConfig.check_iss_has_one_client"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig.check_iss_has_one_client">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">check_iss_has_one_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Our issuers have multiple clients.</span>

<span class="sd">        The issuer is not unique, some LMSes (Canvas, Blackboard) even use the</span>
<span class="sd">        same ``iss`` for every deployment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LTIConfig.find_registration_by_issuer"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig.find_registration_by_issuer">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">find_registration_by_issuer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;message_launch&#39;</span><span class="p">,</span> <span class="s1">&#39;oidc_login&#39;</span><span class="p">],</span>
                          <span class="n">FlaskRequest</span><span class="p">,</span> <span class="s1">&#39;_LaunchData&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Registration</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find the registration in a legacy way.</span>

<span class="sd">        &gt;&gt;&gt; LTIConfig(None).find_registration_by_issuer(&#39;anything&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        AssertionError</span>

<span class="sd">        This is not supported and this method will always raise an</span>
<span class="sd">        :exc:`.AssertionError`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support registration by only issuer&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LTIConfig.find_provider_by_params"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig.find_provider_by_params">[docs]</a>    <span class="k">def</span> <span class="nf">find_provider_by_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the provider using the given ``iss`` and ``client_id``.</span>

<span class="sd">        If this config already has a reference to an</span>
<span class="sd">        :class:`.models.LTI1p3Provider` we simply check that the information</span>
<span class="sd">        passed to us is the same as the information in the provider</span>

<span class="sd">        :param iss: The ``iss`` of the wanted provider.</span>
<span class="sd">        :param client_id: The ``client_id``, pass ``None`` if not available,</span>
<span class="sd">            however in this case there really already should be a provider</span>
<span class="sd">            connect to this instance.</span>

<span class="sd">        :returns: The found provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">LTI1p3Provider</span><span class="o">.</span><span class="n">iss</span> <span class="o">==</span> <span class="n">iss</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">LTI1p3Provider</span><span class="o">.</span><span class="n">client_id</span> <span class="o">==</span> <span class="n">client_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Have to search for an LTI tool without client_id&#39;</span><span class="p">,</span>
                    <span class="n">tool_iss</span><span class="o">=</span><span class="n">iss</span><span class="p">,</span>
                    <span class="n">tool_client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">,</span>
                    <span class="n">report_to_sentry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">filter_single_or_404</span><span class="p">(</span>
                <span class="n">models</span><span class="o">.</span><span class="n">LTI1p3Provider</span><span class="p">,</span> <span class="o">*</span><span class="n">filters</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span><span class="o">.</span><span class="n">iss</span> <span class="o">==</span> <span class="n">iss</span>
            <span class="k">if</span> <span class="n">correct</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span><span class="o">.</span><span class="n">client_id</span> <span class="o">==</span> <span class="n">client_id</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Found incorrect LTI provider&#39;</span><span class="p">,</span>
                    <span class="n">found_iss</span><span class="o">=</span><span class="n">iss</span><span class="p">,</span>
                    <span class="n">provider_iss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span><span class="o">.</span><span class="n">iss</span><span class="p">,</span>
                    <span class="n">found_client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">,</span>
                    <span class="n">provider_client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
                    <span class="n">report_to_sentry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;The provided LTI provider does not match the data in&#39;</span>
                        <span class="s1">&#39; the request&#39;</span>
                    <span class="p">),</span> <span class="p">(</span>
                        <span class="s1">&#39;The found LTI provider info does not match the given&#39;</span>
                        <span class="s1">&#39; provider&#39;</span>
                    <span class="p">),</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">OBJECT_NOT_FOUND</span><span class="p">,</span> <span class="mi">404</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span><span class="o">.</span><span class="n">is_finalized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;This LTI connection is not yet finalized, please make&#39;</span>
                    <span class="s1">&#39; sure you have completed all steps in the wizard.&#39;</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;The LTIProvider </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> is not finalized&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lti_provider</span></div>

<div class="viewcode-block" id="LTIConfig.find_registration_by_params"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig.find_registration_by_params">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">find_registration_by_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">client_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;message_launch&#39;</span><span class="p">,</span> <span class="s1">&#39;oidc_login&#39;</span><span class="p">],</span>
                          <span class="n">FlaskRequest</span><span class="p">,</span> <span class="s1">&#39;_LaunchData&#39;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Registration</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find a registration by params.</span>

<span class="sd">        This simply uses :meth:`.LTIConfig.find_provider_by_params`, see its</span>
<span class="sd">        docstring for how it works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_provider_by_params</span><span class="p">(</span>
            <span class="n">iss</span><span class="o">=</span><span class="n">iss</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get_registration</span><span class="p">()</span></div>

<div class="viewcode-block" id="LTIConfig.find_deployment"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig.find_deployment">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">find_deployment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;We don&#39;t use deployments, this always returns ``None``.</span>

<span class="sd">        &gt;&gt;&gt; LTIConfig(None).find_deployment(&#39;anything&#39;, &#39;anything&#39;) is None</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LTIConfig.find_deployment_by_params"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.LTIConfig.find_deployment_by_params">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">find_deployment_by_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">iss</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;We don&#39;t use deployments, this always returns ``None``.</span>

<span class="sd">        &gt;&gt;&gt; LTIConfig(None).find_deployment_by_params(&#39;any&#39;, &#39;&#39;, &#39;&#39;) is None</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="FlaskMessageLaunch"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch">[docs]</a><span class="k">class</span> <span class="nc">FlaskMessageLaunch</span><span class="p">(</span>
    <span class="n">AbstractLTIConnector</span><span class="p">,</span>
    <span class="n">MessageLaunch</span><span class="p">[</span><span class="n">FlaskRequest</span><span class="p">,</span> <span class="n">LTIConfig</span><span class="p">,</span> <span class="n">FlaskSessionService</span><span class="p">,</span>
                  <span class="n">FlaskCookieService</span><span class="p">]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class handles the launch message, and the second step launch, of</span>
<span class="sd">    the LTI 1.3 protocol and our extension on it.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        The module documentation of :mod:`psef.lti.v1_3` for more information,</span>
<span class="sd">        this class handles everything **after** the OIDC login request. See</span>
<span class="sd">        :class:`.FlaskOIDCLogin` for how that is handled.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_key_set_url_cache_key</span><span class="p">(</span><span class="n">key_set_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;key-url-</span><span class="si">{</span><span class="n">key_set_url</span><span class="si">}</span><span class="s1">&#39;</span>

<div class="viewcode-block" id="FlaskMessageLaunch.validate_jwt_signature"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.validate_jwt_signature">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">validate_jwt_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the jwt signature in the request.</span>

<span class="sd">        This method clears the key set url cache if the validation (implemented</span>
<span class="sd">        in the base class) failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_jwt_signature</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
            <span class="c1"># It might happen that our cache is outdated, in that case remove</span>
            <span class="c1"># the cache and try to validate the signature again.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Validating signature key failed, clearing cache and trying&#39;</span>
                <span class="s1">&#39; again&#39;</span>
            <span class="p">)</span>
            <span class="n">key_set_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span><span class="o">.</span><span class="n">key_set_url</span>
            <span class="k">if</span> <span class="n">key_set_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_registration</span><span class="o">.</span><span class="n">set_key_set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">current_app</span><span class="o">.</span><span class="n">inter_request_cache</span><span class="o">.</span><span class="n">lti_public_keys</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_make_key_set_url_cache_key</span><span class="p">(</span><span class="n">key_set_url</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_jwt_signature</span><span class="p">()</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.fetch_public_key"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.fetch_public_key">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">fetch_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_set_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_KeySet&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the public key at the given url.</span>

<span class="sd">        This method uses a inter request cache for theses keys, so that keys</span>
<span class="sd">        are fetched less. The key for the cache is the url at which the key can</span>
<span class="sd">        be found, i.e. the cache can be shared between different LTI providers.</span>

<span class="sd">        There is no reason to call this method manually, but it is used by the</span>
<span class="sd">        :mod:`pylti1p3` library.</span>

<span class="sd">        :param key_set_url: The url where the key can be found.</span>

<span class="sd">        :returns: The found key, either from the cache or by querying the given</span>
<span class="sd">                  ``key_set_url``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">inter_request_cache</span><span class="o">.</span><span class="n">lti_public_keys</span>
        <span class="n">super_method</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fetch_public_key</span>

        <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_or_set</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_key_set_url_cache_key</span><span class="p">(</span><span class="n">key_set_url</span><span class="p">),</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">super_method</span><span class="p">(</span><span class="n">key_set_url</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.get_lms_name"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.get_lms_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_lms_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span><span class="o">.</span><span class="n">lms_name</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.set_user_role"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.set_user_role">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;models.User&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the role of the given user if the user has no role.</span>

<span class="sd">        If the role could not be matched the ``DEFAULT_ROLE`` configured in the</span>
<span class="sd">        config of the app is used.</span>

<span class="sd">        :param models.User user: The user to set the role for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">roles_claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()[</span><span class="n">claims</span><span class="o">.</span><span class="n">ROLES</span><span class="p">]</span>
        <span class="n">global_roles</span> <span class="o">=</span> <span class="n">SystemRole</span><span class="o">.</span><span class="n">parse_roles</span><span class="p">(</span><span class="n">roles_claim</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Checking global roles&#39;</span><span class="p">,</span>
            <span class="n">given_global_roles</span><span class="o">=</span><span class="n">global_roles</span><span class="p">,</span>
            <span class="n">roles_claim</span><span class="o">=</span><span class="n">roles_claim</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">role_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">global_roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">codegrade_role_name</span>
            <span class="k">if</span> <span class="n">global_roles</span> <span class="k">else</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEFAULT_ROLE&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Role</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">models</span><span class="o">.</span><span class="n">Role</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">role_name</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_resource_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">custom_claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_custom_claims</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">custom_claim</span><span class="o">.</span><span class="n">resource_id</span>

    <span class="k">def</span> <span class="nf">_find_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;models.Course&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;t.Optional[models.Assignment]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the assignment of this launch.</span>

<span class="sd">        :param course: The course of the launch, we will only search inside</span>
<span class="sd">            this course for assignments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id</span><span class="p">()</span>
        <span class="n">old_resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claims</span><span class="o">.</span><span class="n">MIGRATION</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;resource_link_id&#39;</span><span class="p">,</span> <span class="n">resource_id</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span><span class="o">.</span><span class="n">find_assignment</span><span class="p">(</span>
            <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
            <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
            <span class="n">old_resource_id</span><span class="o">=</span><span class="n">old_resource_id</span>
        <span class="p">)</span>

    <span class="c1"># We don&#39;t use the @cg_override.override decorator here as this method</span>
    <span class="c1"># overrides one of our own classes, and I think it makes most sense if we</span>
    <span class="c1"># use the decorator to signal that we override a method from a class</span>
    <span class="c1"># outside of our control (external lib).</span>
<div class="viewcode-block" id="FlaskMessageLaunch.get_assignment"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.get_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;models.Course&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;models.Assignment&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get or create the assignment in this LTI request.</span>

<span class="sd">        :param user: Unused but required as this method overrides a method that</span>
<span class="sd">            specifies it.</span>
<span class="sd">        :param course: The course in which the launch is done, this parameter</span>
<span class="sd">            is used. We assume that the resource (LTI speak for assignment in</span>
<span class="sd">            our case) identifier is unique within a course, so we will only</span>
<span class="sd">            search for assignments inside this course, and created assignments</span>
<span class="sd">            will be created inside this course.</span>

<span class="sd">        :returns: The found or created assignment, updated with the found</span>
<span class="sd">                  information in this launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">launch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()</span>
        <span class="n">resource_claim</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="n">claims</span><span class="o">.</span><span class="n">RESOURCE</span><span class="p">]</span>
        <span class="n">custom_claim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_custom_claims</span><span class="p">()</span>

        <span class="n">assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_assignment</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">assignment</span><span class="o">=</span><span class="n">assignment</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assignment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">resource_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This could easily happen with LTI 1.1, simply using CodeGrade</span>
                <span class="c1"># in another place than assignments. This shouldn&#39;t be the case</span>
                <span class="c1"># for LTI1.3, but better to be sure.</span>
                <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;No resource id was provided for this launch, please&#39;</span>
                        <span class="s1">&#39; check that you are in fact creating an assignment&#39;</span>
                    <span class="p">),</span> <span class="p">(</span>
                        <span class="s1">&#39;The launch was not done in a resource context, so we&#39;</span>
                        <span class="s1">&#39; were not provided with the necessary information.&#39;</span>
                    <span class="p">),</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
                <span class="p">)</span>

            <span class="n">assignment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Assignment</span><span class="p">(</span>
                <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">resource_claim</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
                <span class="n">visibility_state</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">AssignmentVisibilityState</span><span class="o">.</span><span class="n">visible</span><span class="p">,</span>
                <span class="n">is_lti</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">lti_assignment_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">assignment</span><span class="o">.</span><span class="n">lti_grade_service_data</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="n">claims</span><span class="o">.</span><span class="n">GRADES</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">custom_claim</span><span class="o">.</span><span class="n">deadline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">deadline</span> <span class="o">=</span> <span class="n">custom_claim</span><span class="o">.</span><span class="n">deadline</span>

        <span class="c1"># This claim is not required by the LTI spec, so we simply don&#39;t</span>
        <span class="c1"># override the assignment name if it is not given or if it is empty.</span>
        <span class="k">if</span> <span class="n">resource_claim</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">):</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">resource_claim</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">custom_claim</span><span class="o">.</span><span class="n">is_available</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">custom_claim</span><span class="o">.</span><span class="n">is_available</span><span class="p">:</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assignment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span>

        <span class="k">return</span> <span class="n">assignment</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.set_user_course_role"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.set_user_course_role">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_course_role</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="s1">&#39;models.User&#39;</span><span class="p">,</span> <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;models.Course&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">course</span><span class="o">.</span><span class="n">course_lti_provider</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;The given course is not an LTI course&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">course</span><span class="o">.</span><span class="n">course_lti_provider</span><span class="o">.</span><span class="n">maybe_add_user_to_course</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()[</span><span class="n">claims</span><span class="o">.</span><span class="n">ROLES</span><span class="p">],</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">deployment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The deployment id of this LTI launch.</span>

<span class="sd">        Accessing this property raises an :exc:`.LTIException` when the</span>
<span class="sd">        deployment id was not found the launch data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_deployment_id</span><span class="p">()</span>

    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">_get_request_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="FlaskMessageLaunch.from_request"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">lti_provider</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a :class:`.FlaskMessageLaunch` from **untrusted** data.</span>

<span class="sd">        :param lti_provider: If the launch request specified which lti provider</span>
<span class="sd">            to use it should be provided using this parameter. See</span>
<span class="sd">            :meth:`.LTIConfig.find_provider_by_params` for how this provider is</span>
<span class="sd">            used.</span>

<span class="sd">        :returns: The created message launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_request</span> <span class="o">=</span> <span class="n">FlaskRequest</span><span class="p">(</span><span class="n">force_post</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">f_request</span><span class="p">,</span>
            <span class="n">LTIConfig</span><span class="p">(</span><span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">),</span>
            <span class="n">FlaskSessionService</span><span class="p">(</span><span class="n">f_request</span><span class="p">),</span>
            <span class="n">FlaskCookieService</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.get_lti_provider"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.get_lti_provider">[docs]</a>    <span class="k">def</span> <span class="nf">get_lti_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the LTI provider of this launch.</span>

<span class="sd">        .. note::</span>

<span class="sd">            You can only use this method on validated or restored launches.</span>

<span class="sd">        :returns: The found lti provider, see</span>
<span class="sd">                  :meth:`.LTIConfig.find_provider_by_params` for how this</span>
<span class="sd">                  provider is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restored</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registration</span>
        <span class="k">assert</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Registration should be set at this point&#39;</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">get_client_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_config</span><span class="o">.</span><span class="n">find_provider_by_params</span><span class="p">(</span>
            <span class="n">iss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_iss</span><span class="p">(),</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.save_launch_data"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.save_launch_data">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">save_launch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the launch data.</span>

<span class="sd">        We never want to save the launch data in the session, as we have no</span>
<span class="sd">        use-case for it, and it slows down every request. So this method does</span>
<span class="sd">        nothing, however as the base class calls this method it should not</span>
<span class="sd">        raise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.validate_deployment"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.validate_deployment">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">validate_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the found deployment in the launch.</span>

<span class="sd">        This only makes sense when for implementations that hard limit the</span>
<span class="sd">        valid deployments for an LTI connection. As we don&#39;t do this there is</span>
<span class="sd">        nothing to validate. The base class calls this method so it should not</span>
<span class="sd">        raise!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.validate_has_needed_data"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.validate_has_needed_data">[docs]</a>    <span class="k">def</span> <span class="nf">validate_has_needed_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check that all data required by CodeGrade is present in this launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">launch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_exc</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">claim</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">missing</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APIException</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The claim &quot;</span><span class="si">{</span><span class="n">claim</span><span class="si">}</span><span class="s1">&quot; was missing the following keys: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">MISSING_REQUIRED_PARAM</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">check_and_raise</span><span class="p">(</span>
            <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">mapping</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]],</span>
            <span class="o">*</span><span class="n">keys</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mapping</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">get_exc</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>

        <span class="n">user_err_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;We are missing required data about the user doing this LTI&#39;</span>
            <span class="s1">&#39; launch, please check the privacy levels of the tool:&#39;</span>
            <span class="s1">&#39; CodeGrade requires the </span><span class="si">{}</span><span class="s1"> of the user.&#39;</span>
        <span class="p">)</span>
        <span class="n">check_and_raise</span><span class="p">(</span><span class="n">user_err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">launch_data</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_email_for_user</span><span class="p">(</span><span class="n">launch_data</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">get_exc</span><span class="p">(</span><span class="n">user_err_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span> <span class="n">launch_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">launch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claims</span><span class="o">.</span><span class="n">CONTEXT</span><span class="p">)</span>
        <span class="n">check_and_raise</span><span class="p">(</span>
            <span class="s1">&#39;The LTI launch did not contain a context&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_resource_launch</span><span class="p">():</span>
            <span class="n">lti_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span>
            <span class="n">custom</span> <span class="o">=</span> <span class="n">launch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claims</span><span class="o">.</span><span class="n">CUSTOM</span><span class="p">)</span>

            <span class="c1"># We don&#39;t need this info for deep link launches.</span>
            <span class="n">check_and_raise</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;The LTI launch is missing required custom claims, the&#39;</span>
                    <span class="s1">&#39; setup was probably done incorrectly&#39;</span>
                <span class="p">),</span>
                <span class="n">custom</span><span class="p">,</span>
                <span class="o">*</span><span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">get_variable_claims_config</span><span class="p">(</span>
                    <span class="n">lti_provider</span><span class="o">.</span><span class="n">lms_capabilities</span>
                <span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_nrps</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">get_exc</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;It looks like the NamesRoles Provisioning service is&#39;</span>
                        <span class="s1">&#39; not enabled for this LTI deployment, please check&#39;</span>
                        <span class="s1">&#39; your configuration.&#39;</span>
                    <span class="p">),</span>
                    <span class="n">launch_data</span><span class="p">,</span>
                    <span class="n">claims</span><span class="o">.</span><span class="n">NAMESROLES</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">ags</span> <span class="o">=</span> <span class="n">launch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claims</span><span class="o">.</span><span class="n">GRADES</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">check_and_raise</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;It looks like the Assignments and Grades service is not&#39;</span>
                    <span class="s1">&#39; enabled for this LTI deployment, please check your&#39;</span>
                    <span class="s1">&#39; configuration&#39;</span>
                <span class="p">),</span>
                <span class="n">ags</span><span class="p">,</span>
                <span class="s1">&#39;scope&#39;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">scopes</span> <span class="o">=</span> <span class="n">ags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">check_and_raise</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;We do not have the required permissions for passing back&#39;</span>
                    <span class="s1">&#39; grades and updating deadlines in the LMS, please check&#39;</span>
                    <span class="s1">&#39; your configuration&#39;</span>
                <span class="p">),</span>
                <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="kc">True</span>
                 <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scopes</span><span class="p">},</span>
                <span class="o">*</span><span class="n">NEEDED_AGS_SCOPES</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># We don&#39;t need to check the roles claim, as that is required by spec</span>
        <span class="c1"># to always exist. The same for the resource claim, it is also</span>
        <span class="c1"># required.</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">_get_jwt_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_LaunchData&#39;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restored</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_jwt_body</span><span class="p">()</span>

<div class="viewcode-block" id="FlaskMessageLaunch.get_deep_link_settings"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.get_deep_link_settings">[docs]</a>    <span class="k">def</span> <span class="nf">get_deep_link_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_DeepLinkData&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_jwt_body</span><span class="p">()[</span><span class="n">claims</span><span class="o">.</span><span class="n">DEEP_LINK</span><span class="p">]</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.validate"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.validate">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate this request, both for security and data completeness.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The parent method validates the security aspects of the request.</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># If the validation failed this can happen because of a lot of</span>
            <span class="c1"># reasons.  However, if it happens because the user is not allowed</span>
            <span class="c1"># to set cookies (and thus incorrect values were found in the</span>
            <span class="c1"># session) we want to display a nicer error message to the user. To</span>
            <span class="c1"># do this we use our :class:`_TestCookie` class, however this needs</span>
            <span class="c1"># an LTI provider (see docs in the class for why), which we can</span>
            <span class="c1"># only get using the data in the request. So in this except block</span>
            <span class="c1"># we make a copy of the request (so it can never happen that this</span>
            <span class="c1"># request is seen as validated) and do as if it were validated, so</span>
            <span class="c1"># we can get the LTI provider.</span>

            <span class="n">self_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Make sure we can get the lti provider</span>
                <span class="n">self_copy</span><span class="o">.</span><span class="n">_validated</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># pylint: disable=protected-access</span>
                <span class="n">self_copy</span><span class="o">.</span><span class="n">validate_jwt_format</span><span class="p">()</span>
                <span class="n">self_copy</span><span class="o">.</span><span class="n">validate_registration</span><span class="p">()</span>

                <span class="n">_TestCookie</span><span class="o">.</span><span class="n">validate_value_in_request</span><span class="p">(</span>
                    <span class="n">self_copy</span><span class="o">.</span><span class="n">_cookie_service</span><span class="p">,</span>  <span class="c1"># pylint: disable=protected-access</span>
                    <span class="n">self_copy</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># This copy never really should be leaked from this call,</span>
                <span class="c1"># however in the extraordinary case that it is we make sure</span>
                <span class="c1"># that it is longer seen as a validated request.</span>
                <span class="n">self_copy</span><span class="o">.</span><span class="n">_validated</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
                <span class="n">self_copy</span><span class="o">.</span><span class="n">_restored</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>

            <span class="c1"># The error was not a cookie error in this case.</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We don&#39;t need to validate this cookie (launching worked so we</span>
            <span class="c1"># were able to set the necessary cookies), however we do want to</span>
            <span class="c1"># clear it to reduce the size of future requests, and to make sure</span>
            <span class="c1"># the validation still works for future requests.</span>
            <span class="n">_TestCookie</span><span class="o">.</span><span class="n">clear_cookie_in_request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie_service</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_has_needed_data</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validated</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.get_custom_claims"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.get_custom_claims">[docs]</a>    <span class="k">def</span> <span class="nf">get_custom_claims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">ClaimResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get and parse the custom claim in this request.</span>

<span class="sd">        Parsing is not really done here, but in</span>
<span class="sd">        :meth:`.CGCustomClaims.get_custom_claim_data`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">launch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CGCustomClaims</span><span class="o">.</span><span class="n">get_custom_claim_data</span><span class="p">(</span>
            <span class="n">launch_data</span><span class="p">[</span><span class="n">claims</span><span class="o">.</span><span class="n">CUSTOM</span><span class="p">],</span> <span class="n">launch_data</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.ensure_lti_user"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.ensure_lti_user">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_lti_user</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;models.User&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">launch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()</span>
        <span class="n">custom_claims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_custom_claims</span><span class="p">()</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">get_email_for_user</span><span class="p">(</span><span class="n">launch_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">())</span>

        <span class="n">old_lti_user_id</span> <span class="o">=</span> <span class="n">launch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claims</span><span class="o">.</span><span class="n">MIGRATION</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserLTIProvider</span><span class="o">.</span><span class="n">get_or_create_user</span><span class="p">(</span>
            <span class="n">lti_user_id</span><span class="o">=</span><span class="n">launch_data</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">],</span>
            <span class="n">lti_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">(),</span>
            <span class="n">wanted_username</span><span class="o">=</span><span class="n">custom_claims</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">full_name</span><span class="o">=</span><span class="n">full_name</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
            <span class="n">old_lti_user_id</span><span class="o">=</span><span class="n">old_lti_user_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">updated_email</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">reset_email_on_lti</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
            <span class="n">updated_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="n">user</span><span class="o">.</span><span class="n">reset_email_on_lti</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">updated_email</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.get_course"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.get_course">[docs]</a>    <span class="k">def</span> <span class="nf">get_course</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;models.Course&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the course of this LTI launch, or create (and add it to the db</span>
<span class="sd">        session) if it does not yet exist.</span>

<span class="sd">        :returns: The found or created course.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">launch_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_launch_data</span><span class="p">()</span>
        <span class="n">deployment_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_deployment_id</span><span class="p">()</span>
        <span class="n">context_claim</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="n">claims</span><span class="o">.</span><span class="n">CONTEXT</span><span class="p">]</span>
        <span class="n">course_name</span> <span class="o">=</span> <span class="n">context_claim</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="n">lti_course_id</span> <span class="o">=</span> <span class="n">context_claim</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">old_lti_course_id</span> <span class="o">=</span> <span class="n">launch_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">claims</span><span class="o">.</span><span class="n">MIGRATION</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;context_id&#39;</span><span class="p">,</span> <span class="n">lti_course_id</span>
        <span class="p">)</span>

        <span class="n">course_lti_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">()</span><span class="o">.</span><span class="n">find_course</span><span class="p">(</span>
            <span class="n">lti_course_id</span><span class="o">=</span><span class="n">lti_course_id</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">old_lti_course_id</span><span class="o">=</span><span class="n">old_lti_course_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">course_lti_provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">course</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span><span class="o">.</span><span class="n">create_and_add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">course_name</span><span class="p">)</span>
            <span class="n">course_lti_provider</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CourseLTIProvider</span><span class="o">.</span><span class="n">create_and_add</span><span class="p">(</span>
                <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
                <span class="n">lti_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lti_provider</span><span class="p">(),</span>
                <span class="n">lti_context_id</span><span class="o">=</span><span class="n">lti_course_id</span><span class="p">,</span>
                <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">models</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">course</span> <span class="o">=</span> <span class="n">course_lti_provider</span><span class="o">.</span><span class="n">course</span>
            <span class="n">course</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">course_name</span>

        <span class="k">if</span> <span class="n">claims</span><span class="o">.</span><span class="n">NAMESROLES</span> <span class="ow">in</span> <span class="n">launch_data</span><span class="p">:</span>
            <span class="n">names_roles_claim</span> <span class="o">=</span> <span class="n">launch_data</span><span class="p">[</span><span class="n">claims</span><span class="o">.</span><span class="n">NAMESROLES</span><span class="p">]</span>
            <span class="n">course_lti_provider</span><span class="o">.</span><span class="n">names_roles_claim</span> <span class="o">=</span> <span class="n">names_roles_claim</span>

        <span class="k">return</span> <span class="n">course</span></div>

<div class="viewcode-block" id="FlaskMessageLaunch.from_message_data"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskMessageLaunch.from_message_data">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_message_data</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">launch_data</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskMessageLaunch&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a :class:`.FlaskMessageLaunch` from **trusted** input.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            This method will skip all security checks! Do **not** use raw LTI</span>
<span class="sd">            launch data as input to this method, as this will not verify that</span>
<span class="sd">            the launch is valid and correct!</span>

<span class="sd">        :param launch_data: The launch data to use as jwt body.</span>
<span class="sd">        :param lti_provider: The provider of the original request.</span>

<span class="sd">        :returns: The create message launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_request</span> <span class="o">=</span> <span class="n">FlaskRequest</span><span class="p">(</span><span class="n">force_post</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">f_request</span><span class="p">,</span>
            <span class="n">LTIConfig</span><span class="p">(</span><span class="n">lti_provider</span><span class="p">),</span>
            <span class="n">session_service</span><span class="o">=</span><span class="n">FlaskSessionService</span><span class="p">(</span><span class="n">f_request</span><span class="p">),</span>
            <span class="n">cookie_service</span><span class="o">=</span><span class="n">FlaskCookieService</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_auto_validation</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">set_jwt</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;_JwtData&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">launch_data</span><span class="p">}))</span> \
            <span class="o">.</span><span class="n">set_restored</span><span class="p">()</span> \
            <span class="o">.</span><span class="n">validate_registration</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="FlaskOIDCLogin"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskOIDCLogin">[docs]</a><span class="k">class</span> <span class="nc">FlaskOIDCLogin</span><span class="p">(</span>
    <span class="n">OIDCLogin</span><span class="p">[</span><span class="n">FlaskRequest</span><span class="p">,</span> <span class="n">LTIConfig</span><span class="p">,</span> <span class="n">FlaskSessionService</span><span class="p">,</span> <span class="n">FlaskCookieService</span><span class="p">,</span>
              <span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Response</span><span class="p">]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class handles the OIDC login requests of LTI.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        The module documentation of :mod:`psef.lti.v1_3` for more information</span>
<span class="sd">        about what part OIDC login requests play in the entire LTI 1.3 flow.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FlaskOIDCLogin.get_redirect"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskOIDCLogin.get_redirect">[docs]</a>    <span class="nd">@cg_override</span><span class="o">.</span><span class="n">override</span>
    <span class="k">def</span> <span class="nf">get_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaskRedirect</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the redirect that you need to do after the OIDC login.</span>

<span class="sd">        This method sets a test cookie that will later be used to verify that</span>
<span class="sd">        cookies work in the browser of the user.</span>

<span class="sd">        :param url: The url to which you want to redirect. You can probably get</span>
<span class="sd">            this by searching the request for a ``target_link_uri``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_TestCookie</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie_service</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FlaskRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookie_service</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlaskOIDCLogin.from_request"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.FlaskOIDCLogin.from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_request</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">lti_provider</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;models.LTI1p3Provider&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FlaskOIDCLogin&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a :class:`.FlaskOIDCLogin` from the current (global) flask</span>
<span class="sd">        request.</span>

<span class="sd">        The current request will not be copied or anything, so you cannot</span>
<span class="sd">        create this object in a request and then use it in another one.</span>

<span class="sd">        :param lti_provider: The lti provider that has initialized this OIDC</span>
<span class="sd">            login. This will be checked: we will verify (when you start using</span>
<span class="sd">            the returned object) that the information identifying the</span>
<span class="sd">            ``lti_provider`` in the login request matches the given provider.</span>

<span class="sd">        :returns: The created object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f_request</span> <span class="o">=</span> <span class="n">FlaskRequest</span><span class="p">(</span><span class="n">force_post</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FlaskOIDCLogin</span><span class="p">(</span>
            <span class="n">f_request</span><span class="p">,</span>
            <span class="n">LTIConfig</span><span class="p">(</span><span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">),</span>
            <span class="n">FlaskSessionService</span><span class="p">(</span><span class="n">f_request</span><span class="p">),</span>
            <span class="n">FlaskCookieService</span><span class="p">(),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="init_app"><a class="viewcode-back" href="../../../psef_api/psef.html#psef.lti.v1_3.init_app">[docs]</a><span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">PsefFlask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">pass</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, CodeGrade

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>