

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.lti &mdash; CodeGrade v1.19.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v1.19.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guides/use-codegrade-as-a-student.html">How to use CodeGrade as a student</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/getting-started-with-codegrade.html">Getting started with CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/autotest-best-practices.html">Best Practices for AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/creating-an-assignment.html">Create a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/set-up-a-rubric-for-an-assignment.html">Set up a rubric for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-autotest.html">Setting up AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/enabling-continuous-feedback-for-an-assignment.html">Enabling Continuous Feedback for an assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/set-up-group-assignment.html">Set up a CodeGrade group assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-hand-in-requirements.html">Set up hand-in requirements for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setting-up-git-uploads.html">Set up Git uploads for a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/checking-for-plagiarism.html">Check for plagiarism in a CodeGrade assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/dividing-submissions.html">Divide submissions over graders</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/pass-back-grades-to-canvas-blackboard-moodle-brightspace.html">Pass back grades to Canvas, Blackboard, Moodle or Brightspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/creating-managing-and-using-snippets.html">Create, manage and use snippets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/setup-password-for-codegrade-account.html">Set up a password for my CodeGrade account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/using-shortcuts.html">Using shortcuts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/cannot-find-feature-in-codegrade.html">I cannot find a feature in CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/installing-codegrade-filesystem.html">Install the CodeGrade Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/use-codegrade-filesystem.html">Use the CodeGrade Filesystem to locally mount CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/overview.html">Overview of CodeGrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/codeviewer.html">Code Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/management.html">Course and Assignment Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/plagiarism.html">Plagiarism Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/groups.html">Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/preferences.html">Settings and Site Preferences</a></li>
<li class="toctree-l1"><a class="reference external" href="https://fs-docs.codegra.de">Filesystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/lms.html">LMS Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/autotest/overview.html">AutoTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/analytics-dashboard.html">Analytics Dashboard</a></li>
</ul>
<p class="caption"><span class="caption-text">About CodeGrade</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/about.html">About CodeGrade</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developerdocs.html">Developer documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CodeGrade</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../psef.html">psef</a> &raquo;</li>
        
      <li>psef.lti</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.lti</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains the code used for all LTI functionality.</span>

<span class="sd">SPDX-License-Identifier: AGPL-3.0-only AND MIT</span>

<span class="sd">This entire file is licensed as AGPL-3.0-only, except for the code copied</span>
<span class="sd">from https://github.com/ucfopen/lti-template-flask-oauth-tokens which is</span>
<span class="sd">MIT licensed. This copied code is located between the ``# START OF MIT LICENSED</span>
<span class="sd">COPIED WORK #`` and the ``# END OF MIT LICENSED COPIED WORK #`` comment blocks.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">import</span> <span class="nn">oauth2</span>
<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">import</span> <span class="nn">httplib2</span>
<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">import</span> <span class="nn">flask_jwt_extended</span> <span class="k">as</span> <span class="nn">flask_jwt</span>
<span class="kn">from</span> <span class="nn">mypy_extensions</span> <span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span> <span class="nn">defusedxml.ElementTree</span> <span class="kn">import</span> <span class="n">fromstring</span> <span class="k">as</span> <span class="n">defused_xml_fromstring</span>

<span class="kn">from</span> <span class="nn">cg_dt_utils</span> <span class="kn">import</span> <span class="n">DatetimeWithTimezone</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">helpers</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">.auth</span> <span class="kn">import</span> <span class="n">user_active</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.helpers</span> <span class="kn">import</span> <span class="n">register</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">APICodes</span><span class="p">,</span> <span class="n">APIWarnings</span><span class="p">,</span> <span class="n">APIException</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="init_app"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.init_app">[docs]</a><span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">pass</span></div>


<span class="c1"># We do this as defusedxml overrides some of these classes and doing an `import</span>
<span class="c1"># ... as ET` causes different definitions, which means that `ET.ParseError`</span>
<span class="c1"># cannot be excepted.</span>
<span class="n">ET</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">ElementTree</span>

<span class="n">LTI_NAMESPACES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;xmlns&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.imsglobal.org/services/ltiv1p1/xsd/imsoms_v1p0&#39;</span>
<span class="p">}</span>

<span class="n">T_LTI_ROLE</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T_LTI_ROLE&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;LTIRole&#39;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>


<div class="viewcode-block" id="LTIProperty"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIProperty">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LTIProperty</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An LTI property.</span>

<span class="sd">    :ivar internal: The name the property should be names in the launch params.</span>
<span class="sd">    :ivar external: The external name of the property.</span>
<span class="sd">    :ivar error_on_missing: This is considered a essential property.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">internal</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">external</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">error_on_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="LTIRoleException"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIRoleException">[docs]</a><span class="k">class</span> <span class="nc">LTIRoleException</span><span class="p">(</span><span class="n">APIException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thrown when a role could not be parsed.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="LTIRole"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIRole">[docs]</a><span class="k">class</span> <span class="nc">LTIRole</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LTI role, parsed from a role urn. The urn must be of the form</span>
<span class="sd">    urn:lti:{kind}:ims/lis/{name}/{subname}.</span>

<span class="sd">    :ivar ~.LTIRole.name: Primary role name.</span>
<span class="sd">    :ivar subnames: Secondary role names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_LOOKUP</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span>

<div class="viewcode-block" id="LTIRole.parse"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIRole.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">],</span> <span class="n">urn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T_LTI_ROLE</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse the given ``urn`` to a role.</span>

<span class="sd">        :param urn: The urn to parse.</span>
<span class="sd">        :returns: The parsed role.</span>
<span class="sd">        :raises LTIRoleException: If the role is not valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">codegrade_role_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;If not ``None`` this role should be mapped to a CodeGrade role with</span>
<span class="sd">        this name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOOKUP</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOOKUP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="LTIRole.codegrade_role_name_used"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIRole.codegrade_role_name_used">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">codegrade_role_name_used</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the given name used for any known LTI role as CodeGrade role</span>
<span class="sd">            name.</span>

<span class="sd">        This is true if there is any role ``l`` for which</span>
<span class="sd">        ``l.codegrade_role_name == name``.</span>

<span class="sd">        :param name: The CodeGrade role name to check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">cg_name</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">cg_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_LOOKUP</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_get_sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_LOOKUP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if this item is less than the other item.</span>

<span class="sd">        &gt;&gt;&gt; a = LTICourseRole(name=&#39;Instructor&#39;, subnames=[&#39;c&#39;])</span>
<span class="sd">        &gt;&gt;&gt; b = LTICourseRole(name=&#39;Learner&#39;, subnames=[&#39;c&#39;])</span>
<span class="sd">        &gt;&gt;&gt; c = LTIGlobalRole(name=&#39;Instructor&#39;, subnames=[&#39;c&#39;])</span>
<span class="sd">        &gt;&gt;&gt; a &lt; b</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; a &gt; b</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; a.__lt__(c)</span>
<span class="sd">        NotImplemented</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sort_key</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">_get_sort_key</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">],</span> <span class="n">urn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wanted_kind</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T_LTI_ROLE</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse a LTI role from a IMS urn.</span>

<span class="sd">        :param urn: The string to parse.</span>
<span class="sd">        :returns: The parsed LTI role.</span>
<span class="sd">        :raises LTIRoleException: If the role is not valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">role_assert</span><span class="p">(</span><span class="n">should_not_raise</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">should_not_raise</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LTIRoleException</span><span class="p">(</span>
                    <span class="s1">&#39;The given role could not be parsed as an LTI role.&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;The role </span><span class="si">{</span><span class="n">urn</span><span class="si">}</span><span class="s1"> could not be parsed as an LTI role.&#39;</span><span class="p">,</span>
                    <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_PARAM</span><span class="p">,</span> <span class="mi">400</span>
                <span class="p">)</span>

        <span class="n">role_assert</span><span class="p">(</span><span class="n">urn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;urn:lti:&#39;</span><span class="p">))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">urn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">role_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">role_assert</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wanted_kind</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">role_assert</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ims/lis/&#39;</span><span class="p">))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">role_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">subnames</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subnames</span><span class="o">=</span><span class="n">subnames</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subnames</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subnames</span> <span class="o">=</span> <span class="n">subnames</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">subnames</span><span class="p">])</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="LTICourseRole"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTICourseRole">[docs]</a><span class="k">class</span> <span class="nc">LTICourseRole</span><span class="p">(</span><span class="n">LTIRole</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class representing a course LTI role.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_LOOKUP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># LIS standard Context Roles</span>
        <span class="s1">&#39;Learner&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;Instructor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Teacher&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;ContentDeveloper&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Designer&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;Member&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;Administrator&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Teacher&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;TeachingAssistant&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;TA&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="LTICourseRole.parse"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTICourseRole.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">urn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LTICourseRole&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">urn</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="LTIGlobalRole"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIGlobalRole">[docs]</a><span class="k">class</span> <span class="nc">LTIGlobalRole</span><span class="p">(</span><span class="n">LTIRole</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class representing a global LTI role.</span>

<span class="sd">    This class represents both roles of type ``sysrole`` and of type</span>
<span class="sd">    ``instrole``, as CodeGrade handles those both the same way.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_LOOKUP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># LIS standard System Roles,</span>
        <span class="s1">&#39;SysAdmin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;SysSupport&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;Creator&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;AccountAdmin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;User&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Administrator&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;None&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Nobody&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="c1"># LIS standard Institution Roles,</span>
        <span class="s1">&#39;Student&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Faculty&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;Member&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Learner&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Instructor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;Staff&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Staff&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;Alumni&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;ProspectiveStudent&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Guest&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Other&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;Observer&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Student&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">}</span>

<div class="viewcode-block" id="LTIGlobalRole.parse"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIGlobalRole.parse">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">urn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LTIGlobalRole&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">urn</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;sysrole&#39;</span><span class="p">,</span> <span class="s1">&#39;instrole&#39;</span><span class="p">})</span></div></div>


<span class="n">T_LTI</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T_LTI&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;LTI&#39;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="n">lti_classes</span><span class="p">:</span> <span class="n">register</span><span class="o">.</span><span class="n">Register</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;LTI&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">register</span><span class="o">.</span><span class="n">Register</span><span class="p">()</span>


<span class="c1"># TODO: This class has so many public methods as they are properties. A lot of</span>
<span class="c1"># them can be converted to private properties which should be done.</span>
<div class="viewcode-block" id="LTI"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI">[docs]</a><span class="k">class</span> <span class="nc">LTI</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-many-public-methods</span>
    <span class="sd">&quot;&quot;&quot;The base LTI class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LTI.supports_lti_launch_as_result"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.supports_lti_launch_as_result">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_lti_launch_as_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Does this LTI consumer support the ``ltiLaunchUrl`` as result field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LTI.supports_lti_common_cartridge"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.supports_lti_common_cartridge">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_lti_common_cartridge</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this LMS support configuration using a Common Cartridge</span>
<span class="sd">            [common_cartridge]_.</span>

<span class="sd">        .. [common_cartridge] See `here</span>
<span class="sd">            &lt;http://www.imsglobal.org/cc/ccv1p3/imscc_Overview-v1p3.html&gt;`_ for</span>
<span class="sd">            more information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">LTIProvider</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">if</span> <span class="n">lti_provider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">=</span> <span class="n">lti_provider</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lti_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lti_provider_id&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span>
                <span class="n">models</span><span class="o">.</span><span class="n">LTIProvider</span><span class="p">,</span>
                <span class="n">lti_id</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_provider</span><span class="o">.</span><span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_provider</span><span class="o">.</span><span class="n">secret</span>

<div class="viewcode-block" id="LTI.create_from_request"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.create_from_request">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_from_request</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">flask</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;LTI&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an instance from a flask request.</span>

<span class="sd">        The request should have a ``form`` variable that has all the right</span>
<span class="sd">        parameters. So this request should be from an LTI launch.</span>

<span class="sd">        :param req: The request to create the LTI instance from.</span>
<span class="sd">        :returns: A fresh LTI instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">lti_provider</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LTIProvider</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;oauth_consumer_key&#39;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lti_provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lti_provider</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LTIProvider</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;oauth_consumer_key&#39;</span><span class="p">])</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lti_provider</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;lti_provider_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lti_provider</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># This is semi sensitive information so it should not end up in the JWT</span>
        <span class="c1"># token.</span>
        <span class="n">launch_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;oauth&#39;</span><span class="p">):</span>
                <span class="n">launch_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">lti_provider</span><span class="o">.</span><span class="n">lti_class</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">launch_params</span><span class="p">,</span> <span class="n">lti_provider</span><span class="p">)</span>
        <span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_lms_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lti_provider</span><span class="o">.</span><span class="n">lms_name</span>

        <span class="n">auth</span><span class="o">.</span><span class="n">ensure_valid_oauth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="LTI.create_from_launch_params"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.create_from_launch_params">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_from_launch_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;LTI&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an instance from launch params.</span>

<span class="sd">        The params should have an ``lti_class`` key with the name of the class</span>
<span class="sd">        to be instantiated.</span>

<span class="sd">        :param params: The launch params to create the LTI instance from.</span>
<span class="sd">        :returns: A fresh LTI instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lms</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;custom_lms_name&#39;</span><span class="p">]</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">lti_classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lms</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">ensure_lti_data_correct</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="LTI.get_lti_properties"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.get_lti_properties">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_lti_properties</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">LTIProperty</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;All extension properties used by this LMS.</span>

<span class="sd">        :returns: The extension properties needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="LTI.get_custom_extensions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.get_custom_extensions">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_custom_extensions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a string that will be used verbatim in the LTI xml.</span>

<span class="sd">        :returns: A string used as extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="LTI.supports_max_points"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.supports_max_points">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_max_points</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine whether this LMS supports changing the max points.</span>

<span class="sd">        :returns: A boolean indicating whether this LTI instance supports</span>
<span class="sd">            changing the max points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LTI.supports_deadline"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.supports_deadline">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_deadline</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determines whether this LMS sends the deadline of an assignment</span>
<span class="sd">        along with the lti launch request. If it does, the deadline for</span>
<span class="sd">        that assignment cannot be changed from within CodeGrade.</span>

<span class="sd">        :returns: A boolean indicating whether this LTI instance gives the</span>
<span class="sd">            deadline to CodeGrade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_points_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The amount of points possible for the launched assignment.</span>

<span class="sd">        :returns: The possible points or ``None`` if this option is not</span>
<span class="sd">            supported or if the data is not present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The unique id of the current LTI user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_email</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The email of the current LTI user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_person_contact_email_primary&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name of the current LTI user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_person_name_full&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;The username of the current LTI user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;The course id of the current LTI course.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;context_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;The name of the current LTI course.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;context_title&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The id of the current LTI assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name of the current LTI assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outcome_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The url used to passback grades to the LMS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="LTI.has_outcome_service_url"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.has_outcome_service_url">[docs]</a>    <span class="k">def</span> <span class="nf">has_outcome_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the current LTI request has ``outcome_service_url`` field.</span>

<span class="sd">        This is not the case when launch LTI occurs for viewing a result.</span>

<span class="sd">        :returns: A boolean indicating if a ``sourcedid`` field was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">result_sourcedid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The sourcedid of the current user for the current assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">_AssignmentStateEnum</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
        <span class="sd">&quot;&quot;&quot;The state of the current LTI assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">LTICourseRole</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The course roles of the user doing the launch.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">LTIGlobalRole</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The global roles of the user doing the launch.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="LTI.ensure_lti_data_correct"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.ensure_lti_data_correct">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_lti_data_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=no-self-use</span>
        <span class="sd">&quot;&quot;&quot;Make sure the lti data is correct.</span>

<span class="sd">        This is the place were you can do some sanity checks, and make sure the</span>
<span class="sd">        setup of the assignment was done correct.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">role_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]:</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_unsorted_roles</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">role_type</span><span class="p">)</span>
        <span class="n">roles</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">roles</span>

    <span class="k">def</span> <span class="nf">_get_unsorted_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]:</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">role_type</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">role</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">LTIRoleException</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">roles</span>

<div class="viewcode-block" id="LTI.get_assignment_deadline"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.get_assignment_deadline">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignment_deadline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">DatetimeWithTimezone</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the deadline of the current LTI assignment.</span>

<span class="sd">        :param default: The value to be returned of the assignment has no</span>
<span class="sd">            deadline. If ``default.__bool__`` is ``False`` the current date</span>
<span class="sd">            plus 365 days is used.</span>
<span class="sd">        :returns: The deadline of the assignment as a datetime.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="LTI.ensure_lti_user"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.ensure_lti_user">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_lti_user</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Make sure the current LTI user is logged in as a psef user.</span>

<span class="sd">        This is done by first checking if we know a user with the current LTI</span>
<span class="sd">        user_id, if this is the case this is the user we log in and return.</span>

<span class="sd">        Otherwise we check if a user is logged in and this user has no LTI</span>
<span class="sd">        user_id, if this is the case we link the current LTI user_id to the</span>
<span class="sd">        current logged in user and return this user.</span>

<span class="sd">        Otherwise we create a new user and link this user to current LTI</span>
<span class="sd">        user_id.</span>

<span class="sd">        :returns: A tuple containing the items in order: the user found as</span>
<span class="sd">            described above, optionally a new token for the user to login with,</span>
<span class="sd">            optionally the updated email of the user as a string, this is</span>
<span class="sd">            ``None`` if the email was not updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_logged_in</span> <span class="o">=</span> <span class="n">user_active</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">lti_user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">lti_user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
                                               <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_logged_in</span> <span class="ow">and</span> <span class="n">current_user</span><span class="o">.</span><span class="n">lti_user_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
            <span class="c1"># The currently logged in user is now using LTI</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>

        <span class="k">elif</span> <span class="n">lti_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># LTI users are used before the current logged user.</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">flask_jwt</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
                <span class="n">identity</span><span class="o">=</span><span class="n">lti_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">lti_user</span>
        <span class="k">elif</span> <span class="n">is_logged_in</span> <span class="ow">and</span> <span class="n">current_user</span><span class="o">.</span><span class="n">lti_user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO show some sort of screen if this linking is wanted</span>
            <span class="n">current_user</span><span class="o">.</span><span class="n">lti_user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># New LTI user id is found and no user is logged in or the current</span>
            <span class="c1"># user has a different LTI user id. A new user is created and</span>
            <span class="c1"># logged in.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">def</span> <span class="nf">_get_username</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">_get_username</span><span class="p">())</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">(</span>
                <span class="n">lti_user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_email</span><span class="p">,</span>
                <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="n">_get_username</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">token</span> <span class="o">=</span> <span class="n">flask_jwt</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
                <span class="n">identity</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">updated_email</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">reset_email_on_lti</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_email</span>
            <span class="n">updated_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_email</span>
            <span class="n">user</span><span class="o">.</span><span class="n">reset_email_on_lti</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">updated_email</span></div>

<div class="viewcode-block" id="LTI.get_course"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.get_course">[docs]</a>    <span class="k">def</span> <span class="nf">get_course</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the current LTI course as a psef course.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">lti_course_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
                                               <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">course</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">course</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span><span class="o">.</span><span class="n">create_and_add</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_name</span><span class="p">,</span> <span class="n">lti_course_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">course</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_name</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Course changed name&#39;</span><span class="p">,</span>
                <span class="n">old_name</span><span class="o">=</span><span class="n">course</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">new_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">course_name</span>
            <span class="p">)</span>
            <span class="n">course</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_name</span>

        <span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_provider</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">course</span></div>

<div class="viewcode-block" id="LTI.create_and_add_assignment"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.create_and_add_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">create_and_add_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">course</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Assignment</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new assignment in the database from the launch parameters.</span>

<span class="sd">        This function also adds the created assignment to the current session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Assignment</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_name</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_state</span><span class="p">,</span>
            <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span>
            <span class="n">deadline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_assignment_deadline</span><span class="p">(),</span>
            <span class="n">lti_assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">assignment</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">assignment</span></div>

<div class="viewcode-block" id="LTI.get_assignment"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.get_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">course</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Assignment</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the current LTI assignment as a psef assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assignment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Assignment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">lti_assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">assignment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_and_add_assignment</span><span class="p">(</span><span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">deleted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;The launched assignment has been deleted on CodeGrade&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;The assignment &quot;</span><span class="si">{</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&quot; has been deleted&#39;</span><span class="p">,</span>
                <span class="n">APICodes</span><span class="o">.</span><span class="n">OBJECT_NOT_FOUND</span><span class="p">,</span> <span class="mi">404</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">course</span> <span class="o">!=</span> <span class="n">course</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;The assignment was previously connected to a different&#39;</span>
                    <span class="s1">&#39; course.&#39;</span>
                <span class="p">),</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The assignment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_id</span><span class="si">}</span><span class="s1"> was previously&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; connected to </span><span class="si">{</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">),</span> <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_result_sourcedid</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">assignment_results</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">assignment_results</span><span class="p">[</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span>
                                        <span class="p">]</span><span class="o">.</span><span class="n">sourcedid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_sourcedid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assig_res</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AssignmentResult</span><span class="p">(</span>
                    <span class="n">sourcedid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_sourcedid</span><span class="p">,</span>
                    <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment</span><span class="o">.</span><span class="n">id</span>
                <span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">assig_res</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_points_possible</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">lti_points_possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_points_possible</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_outcome_service_url</span><span class="p">():</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">lti_outcome_service_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outcome_service_url</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">assignment</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_state</span>

        <span class="k">if</span> <span class="n">assignment</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_name</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Assignment changed name&#39;</span><span class="p">,</span>
                <span class="n">old_name</span><span class="o">=</span><span class="n">assignment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">new_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_name</span>
            <span class="p">)</span>
            <span class="n">assignment</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_name</span>

        <span class="n">assignment</span><span class="o">.</span><span class="n">deadline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_assignment_deadline</span><span class="p">(</span>
            <span class="n">default</span><span class="o">=</span><span class="n">assignment</span><span class="o">.</span><span class="n">deadline</span>
        <span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">assignment</span></div>

<div class="viewcode-block" id="LTI.set_user_role"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.set_user_role">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the role of the given user if the user has no role.</span>

<span class="sd">        The role is determined according to</span>
<span class="sd">        :py:data:`.LTI_SYSROLE_LOOKUPS`.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If the role could not be matched the ``DEFAULT_ROLE`` configured</span>
<span class="sd">            in the config of the app is used.</span>

<span class="sd">        :param models.User user: The user to set the role for.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">global_roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_roles</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Checking global roles&#39;</span><span class="p">,</span> <span class="n">given_global_roles</span><span class="o">=</span><span class="n">global_roles</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">global_roles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">codegrade_role_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Role</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">role</span><span class="o">.</span><span class="n">codegrade_role_name</span>
                <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="n">user</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Role</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEFAULT_ROLE&#39;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span></div>

<div class="viewcode-block" id="LTI.set_user_course_role"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.set_user_course_role">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_course_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
                             <span class="n">course</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Set the course role for the given course and user if there is no</span>
<span class="sd">        such role just yet.</span>

<span class="sd">        The mapping is done using :py:data:`.LTI_COURSEROLE_LOOKUPS`. If no</span>
<span class="sd">        role could be found a new role is created with the default</span>
<span class="sd">        permissions.</span>

<span class="sd">        :param models.User user: The user to set the course role  for.</span>
<span class="sd">        :param models.Course course: The course to connect to user to.</span>
<span class="sd">        :returns: True if a new role was created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">course</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">courses</span><span class="p">:</span>
            <span class="n">unkown_roles</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">course_roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_roles</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Checking course roles&#39;</span><span class="p">,</span>
                <span class="n">given_course_roles</span><span class="o">=</span><span class="n">course_roles</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">course_roles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">role</span><span class="o">.</span><span class="n">codegrade_role_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unkown_roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">role</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">crole</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                    <span class="n">course_id</span><span class="o">=</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">role</span><span class="o">.</span><span class="n">codegrade_role_name</span>
                <span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="n">user</span><span class="o">.</span><span class="n">courses</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">crole</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">features</span><span class="o">.</span><span class="n">has_feature</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">Feature</span><span class="o">.</span><span class="n">AUTOMATIC_LTI_ROLE</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                    <span class="s1">&#39;The given LTI role could not be found or was not valid. &#39;</span>
                    <span class="s1">&#39;Please ask your instructor or site administrator.&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;No role in &quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">course_roles</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot; is a known LTI role&#39;</span><span class="p">,</span>
                    <span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">400</span>
                <span class="p">)</span>

            <span class="c1"># Add a new course role</span>
            <span class="n">new_created</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_role</span> <span class="o">=</span> <span class="p">(</span><span class="n">unkown_roles</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;New LTI Role&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">existing_role</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                <span class="n">course_id</span><span class="o">=</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">new_role</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">existing_role</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">existing_role</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CourseRole</span><span class="p">(</span>
                    <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">new_role</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">existing_role</span><span class="p">)</span>
                <span class="n">new_created</span> <span class="o">=</span> <span class="n">new_role</span>
            <span class="n">user</span><span class="o">.</span><span class="n">courses</span><span class="p">[</span><span class="n">course</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_role</span>
            <span class="k">return</span> <span class="n">new_created</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LTI.has_result_sourcedid"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.has_result_sourcedid">[docs]</a>    <span class="k">def</span> <span class="nf">has_result_sourcedid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the current LTI request has a ``sourcedid`` field.</span>

<span class="sd">        :returns: A boolean indicating if a ``sourcedid`` field was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="LTI.generate_xml"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.generate_xml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate_xml</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a config XML for this LTI consumer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;lti_common_cartridge.j2&#39;</span><span class="p">,</span>
            <span class="n">external_url</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_URL&#39;</span><span class="p">],</span>
            <span class="n">properties</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_lti_properties</span><span class="p">(),</span>
            <span class="n">custom_extensions</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_custom_extensions</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LTI.passback_grade"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTI.passback_grade">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">passback_grade</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grade</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">service_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sourcedid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_points_possible</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">submission</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Do a LTI grade passback.</span>

<span class="sd">        :param key: The oauth key to use.</span>
<span class="sd">        :param secret: The oauth secret to use.</span>
<span class="sd">        :param grade: The grade to pass back, between 0 and</span>
<span class="sd">            10. If it is `None` the grade will be deleted, if it is a ``bool``</span>
<span class="sd">            no grade information will be send.</span>
<span class="sd">        :param service_url: The url used for grade passback.</span>
<span class="sd">        :param sourcedid: The ``sourcedid`` used in the grade passback.</span>
<span class="sd">        :param lti_points_possible: The maximum amount of points possible for</span>
<span class="sd">            the assignment we are passing back as reported by the LMS during</span>
<span class="sd">            launch.</span>
<span class="sd">        :param host: The host of this CodeGrade instance.</span>
<span class="sd">        :returns: The response of the LTI consumer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_passback_grade</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grade</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">service_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sourcedid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_points_possible</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">submission</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
        <span class="n">use_submission_details</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Doing LTI grade passback&#39;</span><span class="p">,</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">lti_outcome_service_url</span><span class="o">=</span><span class="n">service_url</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="n">grade</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span>
            <span class="n">use_submission_details</span><span class="o">=</span><span class="n">use_submission_details</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lti_operation</span><span class="p">:</span> <span class="n">LTIOperation</span>
        <span class="n">submission_details</span><span class="p">:</span> <span class="n">SubmissionDetails</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">use_submission_details</span><span class="p">:</span>
            <span class="n">submission_details</span><span class="p">[</span><span class="s1">&#39;submittedAt&#39;</span>
                               <span class="p">]</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="n">data_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">LTIResultDataType</span><span class="o">.</span><span class="n">lti_launch_url</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">supports_lti_launch_as_result</span><span class="p">()</span> <span class="k">else</span> <span class="n">LTIResultDataType</span><span class="o">.</span><span class="n">url</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
            <span class="n">lti_operation</span> <span class="o">=</span> <span class="n">LTIInitalReplaceResultOperation</span><span class="p">(</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                <span class="n">data_value</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">submission_details</span><span class="o">=</span><span class="n">submission_details</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">grade</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lti_operation</span> <span class="o">=</span> <span class="n">LTIDeleteResultOperation</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">grade</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">lti_points_possible</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">lti_operation</span> <span class="o">=</span> <span class="n">LTIRawReplaceResultOperation</span><span class="p">(</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                <span class="n">data_value</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">grade</span><span class="o">=</span><span class="nb">str</span><span class="p">((</span><span class="n">grade</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">lti_points_possible</span><span class="p">),</span>
                <span class="n">submission_details</span><span class="o">=</span><span class="n">submission_details</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lti_operation</span> <span class="o">=</span> <span class="n">LTINormalReplaceResultOperation</span><span class="p">(</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                <span class="n">data_value</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">grade</span><span class="o">=</span><span class="nb">str</span><span class="p">((</span><span class="n">grade</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)),</span>
                <span class="n">submission_details</span><span class="o">=</span><span class="n">submission_details</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">OutcomeRequest</span><span class="p">(</span>
            <span class="n">consumer_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">consumer_secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">lis_outcome_service_url</span><span class="o">=</span><span class="n">service_url</span><span class="p">,</span>
            <span class="n">lis_result_sourcedid</span><span class="o">=</span><span class="n">sourcedid</span><span class="p">,</span>
            <span class="n">lti_operation</span><span class="o">=</span><span class="n">lti_operation</span><span class="p">,</span>
            <span class="n">message_identifier</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">post_outcome_request</span><span class="p">()</span></div>


<div class="viewcode-block" id="CanvasLTI"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI">[docs]</a><span class="nd">@lti_classes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;Canvas&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CanvasLTI</span><span class="p">(</span><span class="n">LTI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The LTI class used for the Canvas LMS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CanvasLTI.get_custom_extensions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.get_custom_extensions">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_custom_extensions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a string that will be used verbatim in the LTI xml.</span>

<span class="sd">        :returns: A string used as extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;blti:extensions platform=&quot;canvas.instructure.com&quot;&gt;</span>
<span class="s2">      &lt;lticm:property name=&quot;tool_id&quot;&gt;codegrade&lt;/lticm:property&gt;</span>
<span class="s2">      &lt;lticm:property name=&quot;privacy_level&quot;&gt;public&lt;/lticm:property&gt;</span>
<span class="s2">      &lt;lticm:property name=&quot;domain&quot;&gt;</span><span class="si">{}</span><span class="s2">&lt;/lticm:property&gt;</span>
<span class="s2">    &lt;/blti:extensions&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_URL&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">netloc</span><span class="p">)</span></div>

<div class="viewcode-block" id="CanvasLTI.supports_lti_launch_as_result"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.supports_lti_launch_as_result">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_lti_launch_as_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CanvasLTI.supports_lti_common_cartridge"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.supports_lti_common_cartridge">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_lti_common_cartridge</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Canvas supports common cartridges&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CanvasLTI.ensure_lti_data_correct"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.ensure_lti_data_correct">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_lti_data_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ensure_lti_data_correct</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lti_prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lti_properties</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lti_prop</span><span class="o">.</span><span class="n">error_on_missing</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="n">lti_prop</span><span class="o">.</span><span class="n">internal</span><span class="p">]</span> <span class="o">==</span> <span class="n">lti_prop</span><span class="o">.</span><span class="n">external</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">APIException</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;It seems that CodeGrade was not added correctly as an&#39;</span>
                        <span class="s1">&#39; assignment to this module, are you sure you did not&#39;</span>
                        <span class="s1">&#39; add CodeGrade directly as an external tool?&#39;</span>
                    <span class="p">),</span>
                    <span class="sa">f</span><span class="s2">&quot;The property </span><span class="si">{</span><span class="n">lti_prop</span><span class="o">.</span><span class="n">external</span><span class="si">}</span><span class="s2"> didn&#39;t have a value.&quot;</span><span class="p">,</span>
                    <span class="n">APICodes</span><span class="o">.</span><span class="n">MISSING_REQUIRED_PARAM</span><span class="p">,</span> <span class="mi">400</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="CanvasLTI.get_lti_properties"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.get_lti_properties">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_lti_properties</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">LTIProperty</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;All extension properties used by Canvas.</span>

<span class="sd">        :returns: The extension properties needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_course_name&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.course.name&#39;</span><span class="p">,</span>
                <span class="n">error_on_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_course_id&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.course.id&#39;</span><span class="p">,</span>
                <span class="n">error_on_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_assignment_id&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.assignment.id&#39;</span><span class="p">,</span>
                <span class="n">error_on_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_assignment_title&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.assignment.title&#39;</span><span class="p">,</span>
                <span class="n">error_on_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_assignment_due_at&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.assignment.dueAt.iso8601&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_assignment_published&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.assignment.published&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">LTIProperty</span><span class="p">(</span>
                <span class="n">internal</span><span class="o">=</span><span class="s1">&#39;custom_canvas_points_possible&#39;</span><span class="p">,</span>
                <span class="n">external</span><span class="o">=</span><span class="s1">&#39;$Canvas.assignment.pointsPossible&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="CanvasLTI.supports_max_points"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.supports_max_points">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_max_points</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CanvasLTI.supports_deadline"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.supports_deadline">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_deadline</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_points_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The amount of points possible for the launched assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_points_possible&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_user_login_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_course_name&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_course_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_assignment_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_assignment_title&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outcome_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_outcome_service_url&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="CanvasLTI.has_outcome_service_url"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.has_outcome_service_url">[docs]</a>    <span class="k">def</span> <span class="nf">has_outcome_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;lis_outcome_service_url&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">result_sourcedid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_result_sourcedid&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="CanvasLTI.has_result_sourcedid"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.has_result_sourcedid">[docs]</a>    <span class="k">def</span> <span class="nf">has_result_sourcedid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;lis_result_sourcedid&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span></div>

<div class="viewcode-block" id="CanvasLTI.create_and_add_assignment"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.create_and_add_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">create_and_add_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">course</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Course</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Assignment</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_outcome_service_url</span><span class="p">():</span>
            <span class="n">helpers</span><span class="o">.</span><span class="n">add_warning</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s1">&#39;It seems that CodeGrade was added directly to this module&#39;</span>
                    <span class="s1">&#39; as an external tool, rather than as a CodeGrade&#39;</span>
                    <span class="s1">&#39; assignment. Because of this we do not have the&#39;</span>
                    <span class="s1">&#39; possibility to pass back grades. Make sure to first&#39;</span>
                    <span class="s1">&#39; create a CodeGrade assignment and then connect that&#39;</span>
                    <span class="s1">&#39; assignment to the module.&#39;</span>
                <span class="p">),</span> <span class="n">APIWarnings</span><span class="o">.</span><span class="n">POSSIBLE_LTI_SETUP_ERROR</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_and_add_assignment</span><span class="p">(</span><span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">_AssignmentStateEnum</span><span class="p">:</span>
        <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_assignment_published&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">LTICourseRole</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roles</span><span class="p">(</span><span class="s1">&#39;ext_roles&#39;</span><span class="p">,</span> <span class="n">LTICourseRole</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">LTIGlobalRole</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roles</span><span class="p">(</span><span class="s1">&#39;ext_roles&#39;</span><span class="p">,</span> <span class="n">LTIGlobalRole</span><span class="p">)</span>

<div class="viewcode-block" id="CanvasLTI.get_assignment_deadline"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.get_assignment_deadline">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignment_deadline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;custom_canvas_assignment_due_at&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">deadline</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DatetimeWithTimezone</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">deadline</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">default</span></div>

<div class="viewcode-block" id="CanvasLTI.passback_grade"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.CanvasLTI.passback_grade">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">passback_grade</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grade</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">service_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sourcedid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_points_possible</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">submission</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">redirect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;/courses/</span><span class="si">{course_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/assignments/</span><span class="si">{assig_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/submissions/</span><span class="si">{sub_id}</span><span class="s1">?inLTI=true&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">assig_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="n">sub_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Namespacing this get parameter is important as Canvas duplicates all</span>
        <span class="c1"># get parameters in the body. This makes sure we won&#39;t override actual</span>
        <span class="c1"># launch parameters. Also the url doesn&#39;t need to be quoted, as canvas</span>
        <span class="c1"># does this for us.</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">/api/v1/lti/launch/1?codegrade_redirect=</span><span class="si">{</span><span class="n">redirect</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="n">grade</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span>
            <span class="n">service_url</span><span class="o">=</span><span class="n">service_url</span><span class="p">,</span>
            <span class="n">sourcedid</span><span class="o">=</span><span class="n">sourcedid</span><span class="p">,</span>
            <span class="n">lti_points_possible</span><span class="o">=</span><span class="n">lti_points_possible</span><span class="p">,</span>
            <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
            <span class="n">use_submission_details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="BareBonesLTIProvider"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BareBonesLTIProvider">[docs]</a><span class="k">class</span> <span class="nc">BareBonesLTIProvider</span><span class="p">(</span><span class="n">LTI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The LTI class that implements LTI a for simple &quot;bare bones&quot; LMS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BareBonesLTIProvider.supports_lti_launch_as_result"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BareBonesLTIProvider.supports_lti_launch_as_result">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_lti_launch_as_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_points_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_person_sourcedid&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;context_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;context_title&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;resource_link_id&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;resource_link_title&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outcome_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_outcome_service_url&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="BareBonesLTIProvider.has_outcome_service_url"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BareBonesLTIProvider.has_outcome_service_url">[docs]</a>    <span class="k">def</span> <span class="nf">has_outcome_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;lis_outcome_service_url&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">result_sourcedid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;lis_result_sourcedid&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="BareBonesLTIProvider.has_result_sourcedid"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BareBonesLTIProvider.has_result_sourcedid">[docs]</a>    <span class="k">def</span> <span class="nf">has_result_sourcedid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;lis_result_sourcedid&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">assignment_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">_AssignmentStateEnum</span><span class="p">:</span>
        <span class="c1"># pylint: disable=protected-access</span>
        <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">course_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">LTICourseRole</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roles</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="n">LTICourseRole</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">LTIGlobalRole</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roles</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="n">LTIGlobalRole</span><span class="p">)</span>

<div class="viewcode-block" id="BareBonesLTIProvider.get_assignment_deadline"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BareBonesLTIProvider.get_assignment_deadline">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignment_deadline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DatetimeWithTimezone</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">default</span></div>

<div class="viewcode-block" id="BareBonesLTIProvider.passback_grade"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BareBonesLTIProvider.passback_grade">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">passback_grade</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grade</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">service_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sourcedid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_points_possible</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">submission</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
            <span class="c1"># Bare bones lti providers (like Blackboard) don&#39;t support</span>
            <span class="c1"># passbacks without a grade (which happens for initial</span>
            <span class="c1"># passbacks). Users shouldn&#39;t set a due date on LTI assignments in</span>
            <span class="c1"># blackboard, as all submissions will be considered late.</span>
            <span class="k">return</span>

        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{host}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/courses/</span><span class="si">{course_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/assignments/</span><span class="si">{assig_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/submissions/</span><span class="si">{sub_id}</span><span class="s1">?inLTI=true&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">assig_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="n">sub_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="n">grade</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">service_url</span><span class="o">=</span><span class="n">service_url</span><span class="p">,</span>
            <span class="n">sourcedid</span><span class="o">=</span><span class="n">sourcedid</span><span class="p">,</span>
            <span class="n">lti_points_possible</span><span class="o">=</span><span class="n">lti_points_possible</span><span class="p">,</span>
            <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
            <span class="n">use_submission_details</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="BlackboardLTI"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BlackboardLTI">[docs]</a><span class="nd">@lti_classes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;Blackboard&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BlackboardLTI</span><span class="p">(</span><span class="n">BareBonesLTIProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The LTI class used for the Blackboard LMS.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="MoodleLTI"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.MoodleLTI">[docs]</a><span class="nd">@lti_classes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;Moodle&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MoodleLTI</span><span class="p">(</span><span class="n">BareBonesLTIProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The LTI class used for the Moodle LMS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The username of the current LTI user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;ext_user_username&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="MoodleLTI.supports_lti_common_cartridge"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.MoodleLTI.supports_lti_common_cartridge">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">supports_lti_common_cartridge</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Moodle supports common cartridges&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_get_unsorted_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]:</span>
        <span class="n">roles</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="c1"># Moodle is strange, it gives these two roles as course roles</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="s1">&#39;Instructor&#39;</span><span class="p">,</span> <span class="s1">&#39;Learner&#39;</span>
            <span class="p">}</span> <span class="ow">and</span> <span class="n">role_type</span> <span class="o">==</span> <span class="n">LTICourseRole</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">T_LTI_ROLE</span><span class="p">,</span> <span class="n">LTICourseRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">role</span><span class="p">,</span> <span class="n">subnames</span><span class="o">=</span><span class="p">[]))</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">role_type</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">role</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">LTIRoleException</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">roles</span>

<div class="viewcode-block" id="MoodleLTI.passback_grade"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.MoodleLTI.passback_grade">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">passback_grade</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">grade</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">service_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sourcedid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_points_possible</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">submission</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Work</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
            <span class="c1"># Moodle registers a grade delete as setting the grade to zero.</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">grade</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">{host}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/courses/</span><span class="si">{course_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/assignments/</span><span class="si">{assig_id}</span><span class="s1">&#39;</span>
            <span class="s1">&#39;/submissions/</span><span class="si">{sub_id}</span><span class="s1">?inLTI=true&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">course_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">assig_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
            <span class="n">sub_id</span><span class="o">=</span><span class="n">submission</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_passback_grade</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=</span><span class="n">grade</span><span class="p">,</span>
            <span class="n">initial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">service_url</span><span class="o">=</span><span class="n">service_url</span><span class="p">,</span>
            <span class="n">sourcedid</span><span class="o">=</span><span class="n">sourcedid</span><span class="p">,</span>
            <span class="n">lti_points_possible</span><span class="o">=</span><span class="n">lti_points_possible</span><span class="p">,</span>
            <span class="n">submission</span><span class="o">=</span><span class="n">submission</span><span class="p">,</span>
            <span class="n">use_submission_details</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="BrightSpaceLTI"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.BrightSpaceLTI">[docs]</a><span class="nd">@lti_classes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;BrightSpace&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BrightSpaceLTI</span><span class="p">(</span><span class="n">BareBonesLTIProvider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The LTI class used for the BrightSpace LMS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="s1">&#39;ext_d2l_username&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_unsorted_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role_kind</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]:</span>
        <span class="n">roles</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">T_LTI_ROLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">role_kind</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">role</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">LTIRoleException</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">role_kind</span> <span class="o">!=</span> <span class="n">LTIGlobalRole</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">roles</span><span class="p">:</span>
            <span class="c1"># Some Brightspace instances pass all roles as instrole (global</span>
            <span class="c1"># role). In those cases we yield each global role also as a course</span>
            <span class="c1"># role, because we cannot determine whether a role was meant to be</span>
            <span class="c1"># a global or a course role.</span>
            <span class="k">for</span> <span class="n">global_role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roles</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">LTIGlobalRole</span><span class="p">):</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">role_kind</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">global_role</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">subnames</span><span class="o">=</span><span class="n">global_role</span><span class="o">.</span><span class="n">subnames</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">roles</span></div>


<span class="c1">#####################################</span>
<span class="c1"># START OF MIT LICENSED COPIED WORK #</span>
<span class="c1">#####################################</span>

<span class="c1"># This part is largely copied from https://github.com/tophatmonocle/ims_lti_py</span>
<span class="c1"># and MIT licensed, see below for the entire license.</span>

<span class="c1"># The MIT License (MIT)</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2017 University of Central Florida - Center for Distributed</span>
<span class="c1"># Learning</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in</span>
<span class="c1"># all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>


<div class="viewcode-block" id="LTIResultDataType"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIResultDataType">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">LTIResultDataType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;All possible result data options for an LTI replaceResult request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;url&#39;</span>
    <span class="n">lti_launch_url</span> <span class="o">=</span> <span class="s1">&#39;ltiLaunchUrl&#39;</span></div>


<div class="viewcode-block" id="LTIOperation"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIOperation">[docs]</a><span class="k">class</span> <span class="nc">LTIOperation</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class representing a LTI operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">request_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the name of this operation as required in the LTI xml.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="LTIDeleteResultOperation"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIDeleteResultOperation">[docs]</a><span class="k">class</span> <span class="nc">LTIDeleteResultOperation</span><span class="p">(</span><span class="n">LTIOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A delete result LTI operation.</span>

<span class="sd">    This operation deletes the result at canvas.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">request_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;deleteResultRequest&#39;</span></div>


<span class="n">SubmissionDetails</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="s1">&#39;SubmissionDetails&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;submittedAt&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>


<div class="viewcode-block" id="LTIReplaceResultBaseOperation"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIReplaceResultBaseOperation">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LTIReplaceResultBaseOperation</span><span class="p">(</span><span class="n">LTIOperation</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The base replaceResult LTI operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">request_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;replaceResultRequest&#39;</span>

    <span class="n">data_type</span><span class="p">:</span> <span class="n">LTIResultDataType</span>
    <span class="n">data_value</span><span class="p">:</span> <span class="nb">str</span>

    <span class="n">submission_details</span><span class="p">:</span> <span class="n">SubmissionDetails</span></div>


<div class="viewcode-block" id="LTINormalReplaceResultOperation"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTINormalReplaceResultOperation">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LTINormalReplaceResultOperation</span><span class="p">(</span><span class="n">LTIReplaceResultBaseOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A normal replaceResult with a grade that is in [0, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grade</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="LTIRawReplaceResultOperation"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIRawReplaceResultOperation">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LTIRawReplaceResultOperation</span><span class="p">(</span><span class="n">LTIReplaceResultBaseOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A raw replaceResult with a grade that represents the amount of points a</span>
<span class="sd">    user got for the assignment.</span>

<span class="sd">    .. note:: This is currently only supported by Canvas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grade</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="LTIInitalReplaceResultOperation"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.LTIInitalReplaceResultOperation">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LTIInitalReplaceResultOperation</span><span class="p">(</span><span class="n">LTIReplaceResultBaseOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An initial replaceResult operation, which doens&#39;t provide a grade.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="OutcomeRequest"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.OutcomeRequest">[docs]</a><span class="k">class</span> <span class="nc">OutcomeRequest</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for generating LTI Outcome Requests.</span>

<span class="sd">    Outcome Request documentation:</span>
<span class="sd">        http://www.imsglobal.org/LTI/v1p1/ltiIMGv1p1.html#_Toc319560472</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">lis_outcome_service_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lis_result_sourcedid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">consumer_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">consumer_secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">lti_operation</span><span class="p">:</span> <span class="n">LTIOperation</span><span class="p">,</span>
        <span class="n">message_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lis_outcome_service_url</span> <span class="o">=</span> <span class="n">lis_outcome_service_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lis_result_sourcedid</span> <span class="o">=</span> <span class="n">lis_result_sourcedid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_key</span> <span class="o">=</span> <span class="n">consumer_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="o">=</span> <span class="n">consumer_secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span> <span class="o">=</span> <span class="n">lti_operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_identifier</span> <span class="o">=</span> <span class="n">message_identifier</span>

<div class="viewcode-block" id="OutcomeRequest.post_outcome_request"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.OutcomeRequest.post_outcome_request">[docs]</a>    <span class="k">def</span> <span class="nf">post_outcome_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OutcomeResponse&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send this ``OutcomeRequest`` to the LTI provider.</span>

<span class="sd">        :returns: The parsed response from the provider.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="p">,</span>
            <span class="n">lti_request_message_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">message_identifier</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Posting outcome request&#39;</span><span class="p">)</span>

        <span class="n">consumer</span> <span class="o">=</span> <span class="n">oauth2</span><span class="o">.</span><span class="n">Consumer</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer_key</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer_secret</span>
        <span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">oauth2</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">consumer</span><span class="p">)</span>

        <span class="c1"># monkeypatch the _normalize function to ensures that the</span>
        <span class="c1"># ``Authorization`` header is NOT lower cased</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">_normalize_headers</span>  <span class="c1"># pylint: disable=protected-access</span>

        <span class="k">def</span> <span class="nf">__my_normalize</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;authorization&#39;</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">_normalize_headers</span> <span class="o">=</span> <span class="n">__my_normalize</span>  <span class="c1"># pylint: disable=protected-access</span>
        <span class="n">monkey_patch_function</span> <span class="o">=</span> <span class="n">normalize</span>

        <span class="n">response</span><span class="p">:</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Response</span>
        <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">passback_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_request_xml</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Doing passback request&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">passback_body</span><span class="p">)</span>
        <span class="n">response</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lis_outcome_service_url</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">passback_body</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Restore original function</span>
        <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">_normalize_headers</span> <span class="o">=</span> <span class="n">monkey_patch_function</span>  <span class="c1"># pylint: disable=protected-access</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">response_body</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Posted outcome request&#39;</span><span class="p">)</span>

        <span class="n">outcome</span> <span class="o">=</span> <span class="n">OutcomeResponse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
            <span class="n">lti_response_message_identifier</span><span class="o">=</span><span class="n">outcome</span><span class="o">.</span><span class="n">message_identifier</span><span class="p">,</span>
            <span class="n">lti_response_ref_message_identifier</span><span class="o">=</span><span class="n">outcome</span><span class="o">.</span><span class="n">message_ref_identifier</span><span class="p">,</span>
            <span class="n">lti_code_major</span><span class="o">=</span><span class="n">outcome</span><span class="o">.</span><span class="n">code_major</span><span class="p">,</span>
            <span class="n">lti_severity</span><span class="o">=</span><span class="n">outcome</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span>
            <span class="n">lti_description</span><span class="o">=</span><span class="n">outcome</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">message_ref_identifier</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_identifier</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Received wrong &quot;message_ref_identifier&quot; in request&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">is_failure</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Posting outcome failed&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">outcome</span><span class="o">.</span><span class="n">has_warning</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Posting outcome had a warning&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Posting outcome was successful&#39;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">try_unbind</span><span class="p">(</span>
            <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;response_body&#39;</span><span class="p">,</span> <span class="s1">&#39;operation&#39;</span><span class="p">,</span> <span class="s1">&#39;lti_code_major&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lti_severity&#39;</span><span class="p">,</span> <span class="s1">&#39;lti_description&#39;</span><span class="p">,</span> <span class="s1">&#39;lti_request_message_identifier&#39;</span>
            <span class="s1">&#39;lti_request_message_identifier&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lti_response_ref_message_identifier&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">outcome</span></div>

    <span class="k">def</span> <span class="nf">__generate_request_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate an xml that can be used to perform an outcome request.</span>

<span class="sd">        :returns: The xml as a bytestring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span>
            <span class="s1">&#39;imsx_POXEnvelopeRequest&#39;</span><span class="p">,</span> <span class="n">xmlns</span><span class="o">=</span><span class="n">LTI_NAMESPACES</span><span class="p">[</span><span class="s1">&#39;xmlns&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;imsx_POXHeader&#39;</span><span class="p">)</span>
        <span class="n">header_info</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s1">&#39;imsx_POXRequestHeaderInfo&#39;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">header_info</span><span class="p">,</span> <span class="s1">&#39;imsx_version&#39;</span><span class="p">)</span>
        <span class="n">version</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;V1.0&#39;</span>
        <span class="n">message_identifier</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
            <span class="n">header_info</span><span class="p">,</span> <span class="s1">&#39;imsx_messageIdentifier&#39;</span>
        <span class="p">)</span>
        <span class="n">message_identifier</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_identifier</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;imsx_POXBody&#39;</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="o">.</span><span class="n">request_type</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;resultRecord&#39;</span><span class="p">)</span>

        <span class="n">guid</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s1">&#39;sourcedGUID&#39;</span><span class="p">)</span>

        <span class="n">sourcedid</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="s1">&#39;sourcedId&#39;</span><span class="p">)</span>
        <span class="n">sourcedid</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lis_result_sourcedid</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="p">,</span> <span class="n">LTIReplaceResultBaseOperation</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="p">,</span> <span class="p">(</span>
                    <span class="n">LTINormalReplaceResultOperation</span><span class="p">,</span>
                    <span class="n">LTIRawReplaceResultOperation</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">grade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="o">.</span><span class="n">grade</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="p">,</span> <span class="n">LTIRawReplaceResultOperation</span>
                <span class="p">):</span>
                    <span class="n">result_score</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;resultTotalScore&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result_score</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;resultScore&#39;</span><span class="p">)</span>

                <span class="n">language</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">result_score</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">)</span>
                <span class="n">language</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span>
                <span class="n">text_string</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">result_score</span><span class="p">,</span> <span class="s1">&#39;textString&#39;</span><span class="p">)</span>
                <span class="n">text_string</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">grade</span>

            <span class="n">result_data</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;resultData&#39;</span><span class="p">)</span>
            <span class="n">result_data_el</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span>
                <span class="n">result_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">value</span>
            <span class="p">)</span>
            <span class="n">result_data_el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="o">.</span><span class="n">data_value</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="o">.</span><span class="n">submission_details</span><span class="p">:</span>
                <span class="n">details_el</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;submissionDetails&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_operation</span><span class="o">.</span><span class="n">submission_details</span><span class="o">.</span><span class="n">items</span><span class="p">(</span>
                <span class="p">):</span>
                    <span class="n">sub_details_el</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">details_el</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="n">sub_details_el</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OutcomeResponse"><a class="viewcode-back" href="../../psef_api/psef.html#psef.lti.OutcomeResponse">[docs]</a><span class="k">class</span> <span class="nc">OutcomeResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class consumes LTI Outcome Responses.</span>

<span class="sd">    Response documentation:</span>
<span class="sd">        http://www.imsglobal.org/LTI/v1p1/ltiIMGv1p1.html#_Toc319560472</span>

<span class="sd">    Error code documentation:</span>
<span class="sd">        http://www.imsglobal.org/gws/gwsv1p0/imsgws_baseProfv1p0.html#1639667</span>

<span class="sd">    &gt;&gt;&gt; import doctest</span>
<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; doctest.ELLIPSIS_MARKER = &#39;-etc-&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_file = lambda name: open(</span>
<span class="sd">    ... os.path.join(</span>
<span class="sd">    ...   os.path.dirname(__file__),</span>
<span class="sd">    ...   &#39;..&#39;,</span>
<span class="sd">    ...   &#39;test_data&#39;,</span>
<span class="sd">    ...   &#39;example_strings&#39;,</span>
<span class="sd">    ...   name,</span>
<span class="sd">    ... )).read()</span>

<span class="sd">    &gt;&gt;&gt; res = OutcomeResponse(get_file(&#39;invalid_xml.xml&#39;))</span>
<span class="sd">    -etc-</span>
<span class="sd">    &gt;&gt;&gt; res.code_major, res.severity, res.description</span>
<span class="sd">    (&#39;failure&#39;, &#39;error&#39;, &#39;unknown error&#39;)</span>
<span class="sd">    &gt;&gt;&gt; res.is_success, res.is_failure, res.has_warning</span>
<span class="sd">    (False, True, False)</span>

<span class="sd">    &gt;&gt;&gt; res = OutcomeResponse(get_file(&#39;invalid_replace_result.xml&#39;))</span>
<span class="sd">    -etc-</span>
<span class="sd">    &gt;&gt;&gt; res.code_major, res.severity, res.description</span>
<span class="sd">    (&#39;failure&#39;, &#39;error&#39;, &#39;unknown error&#39;)</span>
<span class="sd">    &gt;&gt;&gt; res.is_success, res.is_failure, res.has_warning</span>
<span class="sd">    (False, True, False)</span>

<span class="sd">    &gt;&gt;&gt; res = OutcomeResponse(get_file(&#39;valid_replace_result.xml&#39;))</span>
<span class="sd">    &gt;&gt;&gt; (</span>
<span class="sd">    ...   res.code_major,</span>
<span class="sd">    ...   res.severity,</span>
<span class="sd">    ...   res.description,</span>
<span class="sd">    ...   res.message_identifier,</span>
<span class="sd">    ...   res.message_ref_identifier,</span>
<span class="sd">    ... )</span>
<span class="sd">    (&#39;success&#39;, &#39;status&#39;, &#39;Score for 3124567 is now 0.92&#39;, &#39;4560&#39;, &#39;999999123&#39;)</span>
<span class="sd">    &gt;&gt;&gt; res.is_success, res.is_failure, res.has_warning</span>
<span class="sd">    (True, False, False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_xml</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_identifier</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">code_major</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">severity</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_ref_identifier</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__process_xml</span><span class="p">(</span><span class="n">input_xml</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a response indicated a success.</span>

<span class="sd">        :returns: ``True`` if the response indicated a success.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_major</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a response indicated a failure.</span>

<span class="sd">        :returns: ``True`` if the response indicated a failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_major</span> <span class="o">==</span> <span class="s1">&#39;failure&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a response had a warning</span>

<span class="sd">        :returns: ``True`` if the response had a warning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;warning&#39;</span>

    <span class="k">def</span> <span class="nf">__process_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_xml</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse OutcomeResponse data form XML.</span>

<span class="sd">        :param xml: The xml to parse.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">WrongValueException</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">get_node</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">LTI_NAMESPACES</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WrongValueException</span><span class="p">(</span>
                    <span class="s1">&#39;Could not find path&#39;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="k">def</span> <span class="nf">get_text</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">get_node</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span><span class="p">:</span> <span class="n">ET</span><span class="o">.</span><span class="n">Element</span> <span class="o">=</span> <span class="n">defused_xml_fromstring</span><span class="p">(</span><span class="n">input_xml</span><span class="p">)</span>

            <span class="c1"># Get message idenifier from header info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_identifier</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span>
                <span class="n">root</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s1">&#39;xmlns:imsx_POXHeader/&#39;</span>
                    <span class="s1">&#39;xmlns:imsx_POXResponseHeaderInfo/&#39;</span>
                    <span class="s1">&#39;xmlns:imsx_messageIdentifier&#39;</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="n">status_node</span> <span class="o">=</span> <span class="n">get_node</span><span class="p">(</span>
                <span class="n">root</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s1">&#39;xmlns:imsx_POXHeader/&#39;</span>
                    <span class="s1">&#39;xmlns:imsx_POXResponseHeaderInfo/&#39;</span>
                    <span class="s1">&#39;xmlns:imsx_statusInfo&#39;</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Get status parameters from header info status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_major</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">status_node</span><span class="p">,</span> <span class="s1">&#39;xmlns:imsx_codeMajor&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">severity</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">status_node</span><span class="p">,</span> <span class="s1">&#39;xmlns:imsx_severity&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span><span class="n">status_node</span><span class="p">,</span> <span class="s1">&#39;xmlns:imsx_description&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_ref_identifier</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span>
                <span class="n">status_node</span><span class="p">,</span> <span class="s1">&#39;xmlns:imsx_messageRefIdentifier&#39;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">get_text</span><span class="p">(</span>
                <span class="n">status_node</span><span class="p">,</span> <span class="s1">&#39;xmlns:imsx_operationRefIdentifier&#39;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">WrongValueException</span><span class="p">,</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Broken xml received&#39;</span><span class="p">,</span>
                <span class="n">xml_received</span><span class="o">=</span><span class="n">xml</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_major</span> <span class="o">=</span> <span class="s1">&#39;failure&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">severity</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;unknown error&#39;</span></div>


<span class="c1">###################################</span>
<span class="c1"># END OF MIT LICENSED COPIED WORK #</span>
<span class="c1">###################################</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, CodeGrade

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>